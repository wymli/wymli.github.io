<!DOCTYPE html>
<html lang="en">
  <head>
    <title>
        [container] 6.ÂÆπÂô®Âü∫Á°Ä‰πãruncÊ∫êÁ†Å - UnderTheHood
      </title>
        <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    
    <meta name="theme-color" content="#000000" />
    
    <meta http-equiv="window-target" content="_top" />
    
    
    <meta name="description" content="git clone https://github.com/opencontainers/runc.git, Êàë‰ª¨ÁÆÄÂçïÈòÖËØª‰∏ãÔºå‰ª£Á†Å‰∏çÂ§ö
ÂÖ•Âè£ ÂÖ•Âè£Ê≤°Âï•Â•ΩËØ¥ÁöÑÔºåÂÖàÊâæmain.goÊñá‰ª∂ÔºåÂèØ‰ª•ÁúãÂà∞runcËøô‰∏™Â∫ìÁî®‰∫Ü github.com/urfave/cli Ëøô‰∏™ÂëΩ‰ª§Ë°åÂ∫ìÂíå github.com/sirupsen/logrus Ëøô‰∏™Êó•ÂøóÂ∫ìÔºåËÉΩÂú®ËøôÁßçÊØîËæÉÈáçË¶ÅÁöÑÂ∑•ÂÖ∑ÈáåÈù¢‰ΩøÁî®ÔºåËØ¥ÊòéËøô‰∏§‰∏™Â∫ìÊòØÂæà‰∏çÈîôÁöÑ„ÄÇ
" />
    <meta name="generator" content="Hugo 0.145.0 with theme pure" />
    <title>[container] 6.ÂÆπÂô®Âü∫Á°Ä‰πãruncÊ∫êÁ†Å - UnderTheHood</title>
    
    
    <link rel="stylesheet" href="https://wymli.github.io/css/style.min.31c841d028bbb1b4f57eadc51e8f652fb1d4f783171c15f4f5de039708e133b3.css">
    
    <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/9.15.10/styles/github.min.css" async>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css" async>
    <meta property="og:url" content="https://wymli.github.io/2025/03/container-6.%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80%E4%B9%8Brunc%E6%BA%90%E7%A0%81/">
  <meta property="og:site_name" content="UnderTheHood">
  <meta property="og:title" content="[container] 6.ÂÆπÂô®Âü∫Á°Ä‰πãruncÊ∫êÁ†Å">
  <meta property="og:description" content="git clone https://github.com/opencontainers/runc.git, Êàë‰ª¨ÁÆÄÂçïÈòÖËØª‰∏ãÔºå‰ª£Á†Å‰∏çÂ§ö
ÂÖ•Âè£ ÂÖ•Âè£Ê≤°Âï•Â•ΩËØ¥ÁöÑÔºåÂÖàÊâæmain.goÊñá‰ª∂ÔºåÂèØ‰ª•ÁúãÂà∞runcËøô‰∏™Â∫ìÁî®‰∫Ü github.com/urfave/cli Ëøô‰∏™ÂëΩ‰ª§Ë°åÂ∫ìÂíå github.com/sirupsen/logrus Ëøô‰∏™Êó•ÂøóÂ∫ìÔºåËÉΩÂú®ËøôÁßçÊØîËæÉÈáçË¶ÅÁöÑÂ∑•ÂÖ∑ÈáåÈù¢‰ΩøÁî®ÔºåËØ¥ÊòéËøô‰∏§‰∏™Â∫ìÊòØÂæà‰∏çÈîôÁöÑ„ÄÇ">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-03-14T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-03-14T00:00:00+00:00">
    <meta property="article:tag" content="Container">
    <meta property="article:tag" content="Oci">
    <meta property="article:tag" content="Runc">

  <meta itemprop="name" content="[container] 6.ÂÆπÂô®Âü∫Á°Ä‰πãruncÊ∫êÁ†Å">
  <meta itemprop="description" content="git clone https://github.com/opencontainers/runc.git, Êàë‰ª¨ÁÆÄÂçïÈòÖËØª‰∏ãÔºå‰ª£Á†Å‰∏çÂ§ö
ÂÖ•Âè£ ÂÖ•Âè£Ê≤°Âï•Â•ΩËØ¥ÁöÑÔºåÂÖàÊâæmain.goÊñá‰ª∂ÔºåÂèØ‰ª•ÁúãÂà∞runcËøô‰∏™Â∫ìÁî®‰∫Ü github.com/urfave/cli Ëøô‰∏™ÂëΩ‰ª§Ë°åÂ∫ìÂíå github.com/sirupsen/logrus Ëøô‰∏™Êó•ÂøóÂ∫ìÔºåËÉΩÂú®ËøôÁßçÊØîËæÉÈáçË¶ÅÁöÑÂ∑•ÂÖ∑ÈáåÈù¢‰ΩøÁî®ÔºåËØ¥ÊòéËøô‰∏§‰∏™Â∫ìÊòØÂæà‰∏çÈîôÁöÑ„ÄÇ">
  <meta itemprop="datePublished" content="2025-03-14T00:00:00+00:00">
  <meta itemprop="dateModified" content="2025-03-14T00:00:00+00:00">
  <meta itemprop="wordCount" content="8564">
  <meta itemprop="keywords" content="Container,Oci,Runc">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="[container] 6.ÂÆπÂô®Âü∫Á°Ä‰πãruncÊ∫êÁ†Å">
  <meta name="twitter:description" content="git clone https://github.com/opencontainers/runc.git, Êàë‰ª¨ÁÆÄÂçïÈòÖËØª‰∏ãÔºå‰ª£Á†Å‰∏çÂ§ö
ÂÖ•Âè£ ÂÖ•Âè£Ê≤°Âï•Â•ΩËØ¥ÁöÑÔºåÂÖàÊâæmain.goÊñá‰ª∂ÔºåÂèØ‰ª•ÁúãÂà∞runcËøô‰∏™Â∫ìÁî®‰∫Ü github.com/urfave/cli Ëøô‰∏™ÂëΩ‰ª§Ë°åÂ∫ìÂíå github.com/sirupsen/logrus Ëøô‰∏™Êó•ÂøóÂ∫ìÔºåËÉΩÂú®ËøôÁßçÊØîËæÉÈáçË¶ÅÁöÑÂ∑•ÂÖ∑ÈáåÈù¢‰ΩøÁî®ÔºåËØ¥ÊòéËøô‰∏§‰∏™Â∫ìÊòØÂæà‰∏çÈîôÁöÑ„ÄÇ">

    <!--[if lte IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
      <![endif]-->

    <!--[if lt IE 9]>
        <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
      <![endif]-->
  </head>

  
  

  <body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="slimContent">
      <div class="navbar-header">
        <div class="profile-block text-center">
          <a id="avatar" href="https://github.com/wymli" target="_blank">
            <img class="img-circle img-rotate" src="https://wymli.github.io/me.jpg" width="200" height="200">
          </a>
          <h2 id="name" class="hidden-xs hidden-sm">Li Weiming</h2>
          <h3 id="title" class="hidden-xs hidden-sm hidden-md">wymli@sysu.cse</h3>
          <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>Guangzhou, China</small>
        </div><div class="search" id="search-form-wrap">
    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i
                        class="icon icon-search"></i></button>
            </span>
        </div>
        <div class="ins-search">
            <div class="ins-search-mask"></div>
            <div class="ins-search-container">
                <div class="ins-input-wrapper">
                    <input type="text" class="ins-search-input" placeholder="Type something..."
                        x-webkit-speech />
                    <button type="button" class="close ins-close ins-selectable" data-dismiss="modal"
                        aria-label="Close"><span aria-hidden="true">√ó</span></button>
                </div>
                <div class="ins-section-wrapper">
                    <div class="ins-section-container"></div>
                </div>
            </div>
        </div>
    </form>
</div>
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
        <ul class="nav navbar-nav main-nav">
            <li class="menu-item menu-item-home">
                <a href="/">
                    <i class="icon icon-home-fill"></i>
                  <span class="menu-title">Home</span>
                </a>
            </li>
            <li class="menu-item menu-item-archives">
                <a href="/posts/">
                    <i class="icon icon-archives-fill"></i>
                  <span class="menu-title">Archives</span>
                </a>
            </li>
            <li class="menu-item menu-item-categories">
                <a href="/categories/">
                    <i class="icon icon-folder"></i>
                  <span class="menu-title">Categories</span>
                </a>
            </li>
            <li class="menu-item menu-item-tags">
                <a href="/tags/">
                    <i class="icon icon-tags"></i>
                  <span class="menu-title">Tags</span>
                </a>
            </li>
            <li class="menu-item menu-item-about">
                <a href="/about/">
                    <i class="icon icon-cup-fill"></i>
                  <span class="menu-title">About</span>
                </a>
            </li>
        </ul>
      </nav>
    </div>
  </header>

<aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">Board</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content"><p>üíïüòéüê±‚Äçüë§üê±‚Äçüèç‚ú®</p>
            </div>
        </div>
    </div>
</div>

      <div class="widget">
    <h3 class="widget-title"> Tags</h3>
    <div id="tag-cloud-list" class="widget-body">
            
            
            <a href="https://wymli.github.io/tags/ai-agent/" class="tag-list-link" rel="1">ai agent<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/airflow/" class="tag-list-link" rel="1">airflow<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/algorithm/" class="tag-list-link" rel="1">algorithm<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/arch/" class="tag-list-link" rel="1">arch<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/argo/" class="tag-list-link" rel="1">argo<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/atomic/" class="tag-list-link" rel="1">atomic<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/bigdata/" class="tag-list-link" rel="3">bigdata<span
               class="tag-list-count">3</span></a>
            
            
            <a href="https://wymli.github.io/tags/bytedance/" class="tag-list-link" rel="1">bytedance<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/c/" class="tag-list-link" rel="2">c<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/cache/" class="tag-list-link" rel="1">cache<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/cli/" class="tag-list-link" rel="2">cli<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/concurrency/" class="tag-list-link" rel="1">concurrency<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/container/" class="tag-list-link" rel="6">container<span
               class="tag-list-count">6</span></a>
            
            
            <a href="https://wymli.github.io/tags/containerd/" class="tag-list-link" rel="1">containerd<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/database/" class="tag-list-link" rel="4">database<span
               class="tag-list-count">4</span></a>
            
            
            <a href="https://wymli.github.io/tags/datamining/" class="tag-list-link" rel="1">datamining<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/datastructure/" class="tag-list-link" rel="1">datastructure<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/db/" class="tag-list-link" rel="1">db<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/deploy/" class="tag-list-link" rel="1">deploy<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/designpattern/" class="tag-list-link" rel="1">designpattern<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/distribute/" class="tag-list-link" rel="1">distribute<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/eino/" class="tag-list-link" rel="1">eino<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/epoll/" class="tag-list-link" rel="1">epoll<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/event-stream/" class="tag-list-link" rel="1">event-stream<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/golang/" class="tag-list-link" rel="20">golang<span
               class="tag-list-count">20</span></a>
            
            
            <a href="https://wymli.github.io/tags/gpu/" class="tag-list-link" rel="2">gpu<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/http/" class="tag-list-link" rel="2">http<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/interview/" class="tag-list-link" rel="3">interview<span
               class="tag-list-count">3</span></a>
            
            
            <a href="https://wymli.github.io/tags/js/" class="tag-list-link" rel="1">js<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/k8s/" class="tag-list-link" rel="5">k8s<span
               class="tag-list-count">5</span></a>
            
            
            <a href="https://wymli.github.io/tags/kafka/" class="tag-list-link" rel="5">kafka<span
               class="tag-list-count">5</span></a>
            
            
            <a href="https://wymli.github.io/tags/llm/" class="tag-list-link" rel="1">llm<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/lsh/" class="tag-list-link" rel="1">lsh<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/net/" class="tag-list-link" rel="1">net<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/oauth2/" class="tag-list-link" rel="1">oauth2<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/oci/" class="tag-list-link" rel="5">oci<span
               class="tag-list-count">5</span></a>
            
            
            <a href="https://wymli.github.io/tags/other/" class="tag-list-link" rel="2">other<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/overlayfs/" class="tag-list-link" rel="1">overlayfs<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/proc/" class="tag-list-link" rel="1">proc<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/python/" class="tag-list-link" rel="1">python<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/redis/" class="tag-list-link" rel="2">redis<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/rpc/" class="tag-list-link" rel="4">rpc<span
               class="tag-list-count">4</span></a>
            
            
            <a href="https://wymli.github.io/tags/runc/" class="tag-list-link" rel="2">runc<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/schedule/" class="tag-list-link" rel="1">schedule<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/scheduler/" class="tag-list-link" rel="1">scheduler<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/script/" class="tag-list-link" rel="1">script<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/server/" class="tag-list-link" rel="3">server<span
               class="tag-list-count">3</span></a>
            
            
            <a href="https://wymli.github.io/tags/socket/" class="tag-list-link" rel="1">socket<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/sys/" class="tag-list-link" rel="2">sys<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/taskqueue/" class="tag-list-link" rel="1">taskqueue<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/temporal/" class="tag-list-link" rel="1">temporal<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/tensorflow/" class="tag-list-link" rel="1">tensorflow<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/todo/" class="tag-list-link" rel="1">todo<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/underthehood/" class="tag-list-link" rel="1">underthehood<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/ut/" class="tag-list-link" rel="1">ut<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/uv/" class="tag-list-link" rel="1">uv<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/volcano/" class="tag-list-link" rel="2">volcano<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/vue/" class="tag-list-link" rel="2">vue<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/workflow/" class="tag-list-link" rel="2">workflow<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/wsl/" class="tag-list-link" rel="1">wsl<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/zookeeper/" class="tag-list-link" rel="1">zookeeper<span
               class="tag-list-count">1</span></a>
            
    </div>
<script>
document.onreadystatechange = () => {
  if (document.readyState === 'complete') {
    tagCloud('#tag-cloud-list a',  8 ,  20 );
  }
};

function tagCloud(where, min, max) {
  let iMax = 0;
  let iMin = 0;
  $(where).each(function() {
    let weight = Number($(this).attr("rel"));
    if(iMax < weight) iMax = weight;
    if(iMin > weight || iMin == 0) iMin = weight;
  });
  let step = (max - min)/(iMax - iMin);
  $(where).each(function() {
    let weight = $(this).attr("rel") - iMin;
    $(this).css({"font-size": min + (weight * step) + 'px'});
  });
};
</script>
</div>

      <div class="widget">
    <h3 class="widget-title"> Categories</h3>
    <div class="widget-body">
        <ul class="category-list">
            <li class="category-list-item"><a href="https://wymli.github.io/categories/ai-agent/" class="category-list-link">ai agent</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/algorithm/" class="category-list-link">algorithm</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/arch/" class="category-list-link">arch</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/argo/" class="category-list-link">argo</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/atomic/" class="category-list-link">atomic</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/bigdata/" class="category-list-link">bigdata</a><span class="category-list-count">3</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/bytedance/" class="category-list-link">bytedance</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/c/" class="category-list-link">c</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/cache/" class="category-list-link">cache</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/cli/" class="category-list-link">cli</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/concurrency/" class="category-list-link">concurrency</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/configcenter/" class="category-list-link">configcenter</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/container/" class="category-list-link">container</a><span class="category-list-count">6</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/database/" class="category-list-link">database</a><span class="category-list-count">4</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/datamining/" class="category-list-link">datamining</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/datastructure/" class="category-list-link">datastructure</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/db/" class="category-list-link">db</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/deploy/" class="category-list-link">deploy</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/distribute/" class="category-list-link">distribute</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/golang/" class="category-list-link">golang</a><span class="category-list-count">20</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/gpu/" class="category-list-link">gpu</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/http/" class="category-list-link">http</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/install/" class="category-list-link">install</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/interview/" class="category-list-link">interview</a><span class="category-list-count">3</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/js/" class="category-list-link">js</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/k8s/" class="category-list-link">k8s</a><span class="category-list-count">5</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/linux/" class="category-list-link">linux</a><span class="category-list-count">3</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/llm/" class="category-list-link">llm</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/messagequeue/" class="category-list-link">messagequeue</a><span class="category-list-count">5</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/net/" class="category-list-link">net</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/os/" class="category-list-link">os</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/os-memory/" class="category-list-link">os-memory</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/other/" class="category-list-link">other</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/protocal/" class="category-list-link">protocal</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/protocol/" class="category-list-link">protocol</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/python/" class="category-list-link">python</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/redis/" class="category-list-link">redis</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/rpc/" class="category-list-link">rpc</a><span class="category-list-count">4</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/script/" class="category-list-link">script</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/sys/" class="category-list-link">sys</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/taskqueue/" class="category-list-link">taskqueue</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/tensorflow/" class="category-list-link">tensorflow</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/todo/" class="category-list-link">todo</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/underthehood/" class="category-list-link">underthehood</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/volcano/" class="category-list-link">volcano</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/vue/" class="category-list-link">vue</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/workflow/" class="category-list-link">workflow</a><span class="category-list-count">2</span></li>
        </ul>
    </div>
</div>
      <div class="widget">
    <h3 class="widget-title"> Tags</h3>
    <div class="widget-body">
        <ul class="tag-list">
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/ai-agent/" class="tag-list-link">ai agent</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/airflow/" class="tag-list-link">airflow</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/algorithm/" class="tag-list-link">algorithm</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/arch/" class="tag-list-link">arch</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/argo/" class="tag-list-link">argo</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/atomic/" class="tag-list-link">atomic</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/bigdata/" class="tag-list-link">bigdata</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/bytedance/" class="tag-list-link">bytedance</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/c/" class="tag-list-link">c</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/cache/" class="tag-list-link">cache</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/cli/" class="tag-list-link">cli</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/concurrency/" class="tag-list-link">concurrency</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/container/" class="tag-list-link">container</a><span
                    class="tag-list-count">6</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/containerd/" class="tag-list-link">containerd</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/database/" class="tag-list-link">database</a><span
                    class="tag-list-count">4</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/datamining/" class="tag-list-link">datamining</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/datastructure/" class="tag-list-link">datastructure</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/db/" class="tag-list-link">db</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/deploy/" class="tag-list-link">deploy</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/designpattern/" class="tag-list-link">designpattern</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/distribute/" class="tag-list-link">distribute</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/eino/" class="tag-list-link">eino</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/epoll/" class="tag-list-link">epoll</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/event-stream/" class="tag-list-link">event-stream</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/golang/" class="tag-list-link">golang</a><span
                    class="tag-list-count">20</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/gpu/" class="tag-list-link">gpu</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/http/" class="tag-list-link">http</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/interview/" class="tag-list-link">interview</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/js/" class="tag-list-link">js</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/k8s/" class="tag-list-link">k8s</a><span
                    class="tag-list-count">5</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/kafka/" class="tag-list-link">kafka</a><span
                    class="tag-list-count">5</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/llm/" class="tag-list-link">llm</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/lsh/" class="tag-list-link">lsh</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/net/" class="tag-list-link">net</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/oauth2/" class="tag-list-link">oauth2</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/oci/" class="tag-list-link">oci</a><span
                    class="tag-list-count">5</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/other/" class="tag-list-link">other</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/overlayfs/" class="tag-list-link">overlayfs</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/proc/" class="tag-list-link">proc</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/python/" class="tag-list-link">python</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/redis/" class="tag-list-link">redis</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/rpc/" class="tag-list-link">rpc</a><span
                    class="tag-list-count">4</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/runc/" class="tag-list-link">runc</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/schedule/" class="tag-list-link">schedule</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/scheduler/" class="tag-list-link">scheduler</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/script/" class="tag-list-link">script</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/server/" class="tag-list-link">server</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/socket/" class="tag-list-link">socket</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/sys/" class="tag-list-link">sys</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/taskqueue/" class="tag-list-link">taskqueue</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/temporal/" class="tag-list-link">temporal</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/tensorflow/" class="tag-list-link">tensorflow</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/todo/" class="tag-list-link">todo</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/underthehood/" class="tag-list-link">underthehood</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/ut/" class="tag-list-link">ut</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/uv/" class="tag-list-link">uv</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/volcano/" class="tag-list-link">volcano</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/vue/" class="tag-list-link">vue</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/workflow/" class="tag-list-link">workflow</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/wsl/" class="tag-list-link">wsl</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/zookeeper/" class="tag-list-link">zookeeper</a><span
                    class="tag-list-count">1</span></li>
            
        </ul>

    </div>
</div>
      
<div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
        <ul class="recent-post-list list-unstyled no-thumbnail">
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://wymli.github.io/2021/04/a1underthehood-underthehood/" class="title">[UnderTheHood] Âü∫Á°Ä-ÈáçË¶Å-Áü•ËØÜ-ÊïôÊó®-Ê†ºË®Ä-Ëùâ</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2021-04-10 00:00:00 &#43;0000 UTC" itemprop="datePublished">2021-04-10</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://wymli.github.io/2025/06/learning-redis-datastructure/" class="title">Learning: Redis DataStructure</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2025-06-12 00:00:00 &#43;0000 UTC" itemprop="datePublished">2025-06-12</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://wymli.github.io/2025/06/gpu-learning-gpu-patitioning-and-nvidia-gpu-operator/" class="title">Learning: GPU Patitioning and NVIDIA GPU Operator</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2025-06-09 00:00:00 &#43;0000 UTC" itemprop="datePublished">2025-06-09</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://wymli.github.io/2025/06/argo-learning-argo/" class="title">[argo] Learning: Argo</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2025-06-07 00:00:00 &#43;0000 UTC" itemprop="datePublished">2025-06-07</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://wymli.github.io/2025/05/js-javascript-is-all-you-need/" class="title">JS: Javascript is all you need</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2025-05-30 00:00:00 &#43;0000 UTC" itemprop="datePublished">2025-05-30</time>
                    </p>
                </div>
            </li>
        </ul>
    </div>
</div>
  </div>
</aside>

    
    
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <h4 class="toc-title">Catalogue</h4>
    <nav id="toc" class="js-toc toc">

    </nav>
  </div>
</aside>
<main class="main" role="main"><div class="content">
  <article id="-" class="article article-type-" itemscope
    itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      <h1 itemprop="name">
  <a
    class="article-title"
    href="/2025/03/container-6.%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80%E4%B9%8Brunc%E6%BA%90%E7%A0%81/"
    >[container] 6.ÂÆπÂô®Âü∫Á°Ä‰πãruncÊ∫êÁ†Å</a
  >
</h1>

      <div class="article-meta">
        
<span class="article-date">
  <i class="icon icon-calendar-check"></i>&nbsp;
<a href="https://wymli.github.io/2025/03/container-6.%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80%E4%B9%8Brunc%E6%BA%90%E7%A0%81/" class="article-date">
  <time datetime="2025-03-14 00:00:00 &#43;0000 UTC" itemprop="datePublished">2025-03-14</time>
</a>
</span>
<span class="article-category">
  <i class="icon icon-folder"></i>&nbsp;
  <a class="article-category-link" href="/categories/container/"> container </a>
</span>  
  <span class="article-tag">
    <i class="icon icon-tags"></i>&nbsp;
    <a class="article-tag-link" href="/tags/container/"> container </a>
    <a class="article-tag-link" href="/tags/oci/"> oci </a>
    <a class="article-tag-link" href="/tags/runc/"> runc </a>
  </span>

		<span class="post-wordcount hidden-xs" itemprop="wordCount">Word Count: 8564 words</span>
		<span class="post-readcount hidden-xs" itemprop="timeRequired">Read Time: 18 minutes </span>
      </div>
    </div>
    <div class="article-entry marked-body js-toc-content" itemprop="articleBody">
      <p>git clone <a href="https://github.com/opencontainers/runc.git">https://github.com/opencontainers/runc.git</a>, Êàë‰ª¨ÁÆÄÂçïÈòÖËØª‰∏ãÔºå‰ª£Á†Å‰∏çÂ§ö</p>
<h1 id="ÂÖ•Âè£">ÂÖ•Âè£</h1>
<p>ÂÖ•Âè£Ê≤°Âï•Â•ΩËØ¥ÁöÑÔºåÂÖàÊâæmain.goÊñá‰ª∂ÔºåÂèØ‰ª•ÁúãÂà∞runcËøô‰∏™Â∫ìÁî®‰∫Ü github.com/urfave/cli Ëøô‰∏™ÂëΩ‰ª§Ë°åÂ∫ìÂíå github.com/sirupsen/logrus Ëøô‰∏™Êó•ÂøóÂ∫ìÔºåËÉΩÂú®ËøôÁßçÊØîËæÉÈáçË¶ÅÁöÑÂ∑•ÂÖ∑ÈáåÈù¢‰ΩøÁî®ÔºåËØ¥ÊòéËøô‰∏§‰∏™Â∫ìÊòØÂæà‰∏çÈîôÁöÑ„ÄÇ</p>
<h1 id="create">create</h1>
<p>createÁöÑÂÆûÈôÖ‰ΩúÁî®ÊòØÁî±runcÊãâËµ∑‰∏Ä‰∏™ runcÔºàÈÄöÂ∏∏Áß∞‰∏∫parentProcessÔºå‰πüÂ∞±ÊòØ runc create &hellip; Ëøô‰∏™ËøõÁ®ãÔºâ ÊãâËµ∑‰∏Ä‰∏™Â≠êruncËøõÁ®ãÔºàÈÄöÂ∏∏Áß∞‰∏∫childProcess, ÊàñÊõ¥Á≤æÁ°ÆÁöÑÔºåinitProcessÔºâÔºåÂ≠êruncËøõÁ®ãÁöÑÊâßË°åÂëΩ‰ª§‰∏∫ <code>runc init</code>, ÊâßË°åÂêé‰ºöËøõË°åÊâÄÊúâns/rootfsÁöÑÂàùÂßãÂåñÊìç‰ΩúÔºåÂπ∂ÈòªÂ°ûÂú®ÊâìÂºÄexec.fifoÂëΩÂêçÁÆ°ÈÅì‰∏äÔºåÁ≠âÂæÖstartÊåá‰ª§ÔºåÊî∂Âà∞Êåá‰ª§‰πãÂêé‰ºöÁ´ãÂç≥ÊâßË°åsystem.ExecÂéüÂú∞Â∞ÜËá™Â∑±ÊõøÊç¢ÊàêÁî®Êà∑‰∏ªËøõÁ®ã„ÄÇ<br>
ËøôÈáåÊúâÊó†startÂÖ∂ÂÆûÈÉΩ‰∏çÂ§™ÈáçË¶ÅÔºåcreate‰πãÂêéÂÆπÂô®ÁéØÂ¢ÉÂ∞±ÂàõÂª∫Â•Ω‰∫ÜÔºåÂêéÁª≠Êó†ËÆ∫ÊòØstartËøòÊòØexecÈÉΩË°åÔºå‰∏Ä‰∏™ÊòØÊâßË°åconfig.jsonÈáåÁöÑ‰∏ªËøõÁ®ãÔºå‰∏Ä‰∏™ÊòØÊâßË°åexecÂëΩ‰ª§Ë°åÈáåÁöÑËøõÁ®ã„ÄÇ</p>
<h2 id="notifysock-ÂàõÂª∫">notify.sock ÂàõÂª∫</h2>
<p>Â¶ÇÊûúÊåáÂÆö‰∫ÜÁéØÂ¢ÉÂèòÈáè NOTIFY_SOCKETÔºå ‰ºöÂàõÂª∫notify.sock<br>
ÈªòËÆ§ÂàõÂª∫Âú® ${root}/${container_name}/notify/notify.sock, rootÊòØ/run/runc ÊàñËÄÖ /run/user/1000/runc</p>
<pre><code>notifySocket := newNotifySocket(context, os.Getenv(&quot;NOTIFY_SOCKET&quot;), id)
if notifySocket != nil {
    notifySocket.setupSpec(spec) // Âú® config.json ‰∏≠Ê∑ªÂä† notify.socket ÁöÑmountÂíåenv
}

// ...
// ÂàõÂª∫ÂÆπÂô® ...
// ...

if notifySocket != nil {
    if err := notifySocket.setupSocketDirectory(); err != nil { // ÂàõÂª∫ÁõÆÂΩïÂíåÊùÉÈôê os.Mkdir(path.Dir(s.socketPath), 0o755)
        return -1, err
    }
    if action == CT_ACT_RUN { // Â¶ÇÊûúÊòØÂú®ËøêË°åÂÆπÂô®ÔºåÂ∞±ÁîüÊàêsocketÊñá‰ª∂
        if err := notifySocket.bindSocket(); err != nil {
            return -1, err
        }
    }
}
</code></pre>
<p>notifySocket ÁöÑ‰∏ªË¶ÅÈÄªËæëÂÖ∂ÂÆûÂ∞±ÊòØÁõëÂê¨ notify.socket, ËΩ¨ÂèëÂà∞Áî®Êà∑Ëá™ÂÆö‰πâÁöÑ socket addr, Â∫îËØ•ÊòØÁî®Êù•ÂÆûÁé∞‰∏Ä‰∫õ‰∫ã‰ª∂È©±Âä®ÁöÑ</p>
<pre><code>func (n *notifySocket) run(pid1 int) error {
	if n.socket == nil {
		return nil
	}
	notifySocketHostAddr := net.UnixAddr{Name: n.host, Net: &quot;unixgram&quot;}
	client, err := net.DialUnix(&quot;unixgram&quot;, nil, &amp;notifySocketHostAddr)
	if err != nil {
		return err
	}

	ticker := time.NewTicker(time.Millisecond * 100)
	defer ticker.Stop()

	fileChan := make(chan []byte)
	go func() {
		for {
			buf := make([]byte, 4096)
			r, err := n.socket.Read(buf)
			if err != nil {
				return
			}
			got := buf[0:r]
			// systemd-ready sends a single datagram with the state string as payload,
			// so we don't need to worry about partial messages.
			for _, line := range bytes.Split(got, []byte{'\n'}) {
				if bytes.HasPrefix(got, []byte(&quot;READY=&quot;)) {
					fileChan &lt;- line
					return
				}
			}

		}
	}()

	for {
		select {
		case &lt;-ticker.C:
			_, err := os.Stat(filepath.Join(&quot;/proc&quot;, strconv.Itoa(pid1)))
			if err != nil {
				return nil
			}
		case b := &lt;-fileChan:
			return notifyHost(client, b, pid1)
		}
	}
}
</code></pre>
<h2 id="systemd-on-demand-socket">systemd on-demand socket</h2>
<p>ËøôÈáåÂ≠¶Âà∞‰∏Ä‰∏™Êñ∞Áü•ËØÜÔºåsystemd on-demand socketÔºåÂ§ßËá¥ÊÑèÊÄùÊó∂ÔºåÈÖçÁΩÆ‰∏Ä‰∏™systemdÁöÑsocketÊñá‰ª∂ÔºåÁõëÂê¨Êüê‰∏™Á´ØÂè£ÔºåÂÜçÈÖçÁΩÆ‰∏Ä‰∏™systemdÁöÑserviceÊñá‰ª∂ÔºåÂÖ≥ËÅîÊüê‰∏™socketÊñá‰ª∂ÔºåÈöèÂêéÔºåÂΩìËØ∑Ê±ÇÊâìÂà∞socketÊñá‰ª∂ÂÖ≥ËÅîÁöÑÁ´ØÂè£Êó∂Ôºå‰ºöÂêØÂä®serviceÊñá‰ª∂ÔºåÂÅöÂà∞ÊåâÈúÄÂêØÂä®ÁöÑÂäüËÉΩ„ÄÇ</p>
<pre><code>// Support on-demand socket activation by passing file descriptors into the container init process.
listenFDs := []*os.File{}
if os.Getenv(&quot;LISTEN_FDS&quot;) != &quot;&quot; {
    listenFDs = activation.Files(false)
}

// ...
if len(r.listenFDs) &gt; 0 {
    process.Env = append(process.Env, &quot;LISTEN_FDS=&quot;+strconv.Itoa(len(r.listenFDs)), &quot;LISTEN_PID=1&quot;)
    process.ExtraFiles = append(process.ExtraFiles, r.listenFDs...) // Â∫îËØ•ÊòØ‰∏∫‰∫ÜÂÆπÂô®ÂÜÖÁöÑËøõÁ®ãÂèØ‰ª•ËØªÂà∞LISTEN_FD
}
</code></pre>
<p>ÂõûÂ§¥‰∏ìÈó®ÂºÄ‰∏ÄÁ´†Ë∑ë‰∏™demoËØïËØïÔºåÊúâÁÇπfaasÁöÑÊÑèÊÄù</p>
<h2 id="create-container">create container</h2>
<pre><code>func createContainer(context *cli.Context, id string, spec *specs.Spec) (*libcontainer.Container, error) {
	rootlessCg, err := shouldUseRootlessCgroupManager(context) // ÂÜÖÂÆπÊöÇÊó∂Áúã‰∏çÊáÇÔºåÂèçÊ≠£Â∞±ÊòØÂáÜÂ§árootless cgroupÈÖçÁΩÆ
	if err != nil {
		return nil, err
	}
	config, err := specconv.CreateLibcontainerConfig(&amp;specconv.CreateOpts{ // Ëøô‰∏ÄÊ≠•ÊòØÂ∞Ürunc ÁöÑconfigËΩ¨Êàê libcontainerÁöÑconfig
		CgroupName:       id,
		UseSystemdCgroup: context.GlobalBool(&quot;systemd-cgroup&quot;),
		NoPivotRoot:      context.Bool(&quot;no-pivot&quot;),
		NoNewKeyring:     context.Bool(&quot;no-new-keyring&quot;),
		Spec:             spec,
		RootlessEUID:     os.Geteuid() != 0,
		RootlessCgroups:  rootlessCg,
	})
	if err != nil {
		return nil, err
	}

	root := context.GlobalString(&quot;root&quot;)
	return libcontainer.Create(root, id, config) // ÂæóÂà∞‰∫Ü‰∏Ä‰∏™ Container ÁªìÊûÑ‰Ωì
}
</code></pre>
<h2 id="Â§ÑÁêÜcontainer-console-io">Â§ÑÁêÜcontainer console io</h2>
<p>Êàë‰ª¨Áü•ÈÅìdocker‰∏ÄËà¨Êúâ <code>-i</code>, <code>-t</code>, <code>-d</code> ÈÄâÈ°πÂíåconsole ioÊúâÂÖ≥</p>
<ul>
<li>-i ‰∫§‰∫íÊ®°ÂºèÔºöÂÆπÂô®ÂÖ±‰∫´Áà∂ËøõÁ®ãÁöÑstdin/stdout/stderr</li>
<li>-t ÊâìÂºÄ‰∏Ä‰∏™‰º™ÁªàÁ´Ø: ‰º™ÁªàÁ´ØÁöÑÊÑè‰πâÂ∞±ÊòØÂ∞Üstdin/stdoutÂèòÂæó‰∏çÂÜçÊòØ‰∏Ä‰∏™ËæìÂÖ•ËæìÂá∫ÊµÅÔºåËÄåÊòØÂÉè‰∏Ä‰∏™ÁúüÁöÑÁªàÁ´Ø‰∏ÄÁÇπÔºåÊîØÊåÅÊéßÂà∂Â≠óÁ¨¶‰πãÁ±ªÁöÑÔºåÊØîÂ¶ÇÈÄÄÊ†ºÈîÆÂíåÊñπÂêëÈîÆÔºåÊØîÂ¶ÇÊòæÁ§∫È¢úËâ≤</li>
<li>-d detachÔºöÂÆπÂô®Âú®ÂêéÂè∞ËøêË°åÔºå‰∏çÂç†Áî®ÂΩìÂâçÁªàÁ´Ø</li>
</ul>
<pre><code>
// setupIO modifies the given process config according to the options.
func setupIO(process *libcontainer.Process, container *libcontainer.Container, createTTY, detach bool, sockpath string) (*tty, error) {
    // -t ÂØπÂ∫î createTTY
	if createTTY {
		process.Stdin = nil // Ê∏ÖÁ©∫ËøõÁ®ãÁöÑÊ†áÂáÜËæìÂÖ•ËæìÂá∫
		process.Stdout = nil
		process.Stderr = nil
		t := &amp;tty{}
		if !detach {
			if err := t.initHostConsole(); err != nil { // ‰ªé stderr, stdout, stdin ‰∏≠ÊâæÂà∞‰∏Ä‰∏™ÊúâÊïàÁöÑconsole(tty)ÔºåÂõ†‰∏∫ÊúâÂèØËÉΩÂΩìÂâçËøõÁ®ãÂπ∂Ê≤°Êúâattach‰∏Ä‰∏™console
				return nil, err
			}
			parent, child, err := utils.NewSockPair(&quot;console&quot;)
			if err != nil {
				return nil, err
			}
			process.ConsoleSocket = child
			t.postStart = append(t.postStart, parent, child) // io.closer
			t.consoleC = make(chan error, 1) // Ëøô‰∏™Â∞±ÊòØ‰∏Ä‰∏™ÁÆÄÂçïÁöÑwait‰ø°Âè∑‰∫ÜÔºåconsole channel
			go func() {
				t.consoleC &lt;- t.recvtty(parent)
			}()
		} else {
			// the caller of runc will handle receiving the console master
			conn, err := net.Dial(&quot;unix&quot;, sockpath)
			if err != nil {
				return nil, err
			}
			uc, ok := conn.(*net.UnixConn)
			if !ok {
				return nil, errors.New(&quot;casting to UnixConn failed&quot;)
			}
			t.postStart = append(t.postStart, uc)
			socket, err := uc.File()
			if err != nil {
				return nil, err
			}
			t.postStart = append(t.postStart, socket)
			process.ConsoleSocket = socket // Â¶ÇÊûúÊåáÂÆö‰∫ÜdetachÔºåÂèàÊÉ≥ÂàÜÈÖçttyÔºåÂ∞±ÂæóÊåáÂÆö‰∏Ä‰∏™socket path
		}
		return t, nil
	}
	// when runc will detach the caller provides the stdio to runc via runc's 0,1,2
	// and the container's process inherits runc's stdio.
	if detach {
        // Áõ¥Êé•ÁªßÊâøruncËøõÁ®ãÁöÑstdioÔºåÂèØ‰ª•Âíå setupProcessPipes ÂØπÊØîÔºå setupProcessPipesÊòØÊñ∞Âª∫pipeÔºåÂú®runcËøõÁ®ãÁöÑstdio‰πãÈó¥Êã∑Ë¥ù
        // Áõ¥Êé•ÁªßÊâøÁöÑÂéüÂõ†ÊòØ‰ªÄ‰πàÔºü
		inheritStdio(process) // ‰ΩøÁî®runcËøõÁ®ãÁöÑstdio, ‰πüÂ∞±ÊòØos.stdout, os.stdin, os.stderr
		return &amp;tty{}, nil
	}

	config := container.Config()
	rootuid, err := config.HostRootUID() // rootlessÁõ∏ÂÖ≥ÈÖçÁΩÆ
	if err != nil {
		return nil, err
	}
	rootgid, err := config.HostRootGID() // rootlessÁõ∏ÂÖ≥ÈÖçÁΩÆ
	if err != nil {
		return nil, err
	}

    // Â¶ÇÊûúÊó¢Ê≤°ÊúâttyÔºå‰πüÊ≤°ÊúâdetachÔºåËøõÂÖ•ËøôÈáå
	return setupProcessPipes(process, rootuid, rootgid)
}


// setup pipes for the process so that advanced features like c/r are able to easily checkpoint
// and restore the process's IO without depending on a host specific path or device
func setupProcessPipes(p *libcontainer.Process, rootuid, rootgid int) (*tty, error) {
	i, err := p.InitializeIO(rootuid, rootgid) ÂàõÂª∫ os.Pipe, wÁ´ØÊåÇÂú®process‰∏äÔºårÁ´ØÊåÇÂú®iÔºåiÂ∞Ü‰ºöË¢´‰∏ãÈù¢ÁöÑ‰ª£Á†Å‰ΩøÁî®
    // ËøôÈáåË¶ÅÊñ∞ÂàõÂª∫‰∏Ä‰∏™os.PipeÔºåËÄå‰∏çÊòØÁõ¥Êé•ÁªßÊâøruncËøõÁ®ãÁöÑstdioÁöÑÂéüÂõ†ÊòØ‰ªÄ‰πàÔºüÂèØËÉΩÊòØÊÄïÂ§öËøõÁ®ãÂÜôÂêå‰∏Ä‰∏™pipeÂÜôÂùè‰∫Ü?
	if err != nil {
		return nil, err
	}
	t := &amp;tty{
		closers: []io.Closer{
			i.Stdin,
			i.Stdout,
			i.Stderr,
		},
	}
	// add the process's io to the post start closers if they support close
	for _, cc := range []interface{}{
		p.Stdin,
		p.Stdout,
		p.Stderr,
	} {
		if c, ok := cc.(io.Closer); ok {
			t.postStart = append(t.postStart, c)
		}
	}
	go func() {
		_, _ = io.Copy(i.Stdin, os.Stdin) // ‰∏ÄÁõ¥copyÁõ¥Âà∞ stdin EOF
		_ = i.Stdin.Close() // stdin ‰∏çÁî® t.copyIO ÊòØÂõ†‰∏∫copyÂÆåÂêéË¶ÅÂÖ≥Èó≠wÁ´Ø
	}()
	t.wg.Add(2)
	go t.copyIO(os.Stdout, i.Stdout) // copyÂÆåÂêéÂÖ≥Èó≠ËØªÁ´Ø, ‰∏ÄÁõ¥copyÁõ¥Âà∞EOF
	go t.copyIO(os.Stderr, i.Stderr)
	return t, nil
}


</code></pre>
<h2 id="init-process">init process</h2>
<p>Âú®startÁöÑÊ†∏ÂøÉÈÄªËæë <code>container.start(process)</code> ‰∏≠ÔºåÈÄöËøá <code>parent, err := c.newParentProcess(process)</code> ÂàõÂª∫Âá∫parentProcess, ËøôÈáåÁöÑ parentProcess Êúâ‰∏§ÁßçÔºåinitProcess Êàñ setnsProcessÔºàËøôÈáåÂÖ∂ÂÆûÂè´ÂÅö ProcessControler Â•Ω‰∏ÄÁÇπÔºå‰ºöÁî±Ëøô‰∏™controlerÂêØÂä®Â≠êËøõÁ®ãÔºåÂπ∂ÂíåÂ≠êËøõÁ®ã‰∫§‰∫íÔºâ<br>
ÁÆÄÂåñÂêéÂ¶Ç‰∏ã:</p>
<pre><code>cmd := exec.Command(&quot;/proc/self/exe&quot;, &quot;init&quot;) // `runc init`
cmd.Args[0] = os.Args[0]
cmd.Stdin = p.Stdin
cmd.Stdout = p.Stdout
cmd.Stderr = p.Stderr
cmd.Dir = c.config.Rootfs

// ...

// ÂàõÂª∫ ipc socket pair (ËøôÈáå‰∏çÂàõÂª∫os.Pipe, ËÄåÊòØuds, Âõ†‰∏∫udsÊòØÂèåÂêëÁöÑÔºåÊõ¥ÁÅµÊ¥ªÔºåÁÆ°ÈÅìÊòØÂçïÂêëÁöÑ)
var (
	comm processComm
	err  error
)
comm.initSockParent, comm.initSockChild, err = utils.NewSockPair(&quot;init&quot;) // initSock(ÊàñËÄÖÊòØinitPipe, ‰ª£Á†ÅÈáåÈù¢ÊòØÊ∑∑Áî®ÁöÑ) ‰ΩúÁî®ÊòØ parentProcessÂíåchildProcessËøõË°å‰∫§‰∫íÔºå‰º†ÈÄíchildProcessÁöÑreal pid Âíå Áî®Êà∑Ëá™ÂÆö‰πâÂëΩ‰ª§Á≠â
if err != nil {
	return nil, fmt.Errorf(&quot;unable to create init pipe: %w&quot;, err)
}
comm.syncSockParent, comm.syncSockChild, err = newSyncSockpair(&quot;sync&quot;)
if err != nil {
	return nil, fmt.Errorf(&quot;unable to create sync pipe: %w&quot;, err)
}
comm.logPipeParent, comm.logPipeChild, err = os.Pipe()
if err != nil {
	return nil, fmt.Errorf(&quot;unable to create log pipe: %w&quot;, err)
}
return &amp;comm, nil

// ...

if p.Init {
	// We only set up fifoFd if we're not doing a `runc exec`. The historic
	// reason for this is that previously we would pass a dirfd that allowed
	// for container rootfs escape (and not doing it in `runc exec` avoided
	// that problem), but we no longer do that. However, there's no need to do
	// this for `runc exec` so we just keep it this way to be safe.
	if err := c.includeExecFifo(cmd); err != nil {
		return nil, fmt.Errorf(&quot;unable to setup exec fifo: %w&quot;, err)
	}
	
	return c.newInitProcess(p, cmd, comm)
	//	init := &amp;initProcess{
	//		containerProcess: containerProcess{
	//			cmd:           cmd, // runc init
	//			comm:          comm, // Âá†‰∏™ÈÄö‰ø°ÁöÑuds
	//			manager:       c.cgroupManager,
	//			config:        c.newInitConfig(p), // ÈáåÈù¢ÊòØ childProcess Áî®Êà∑ËøõÁ®ãÁöÑÂëΩ‰ª§ÔºåÂ¶ÇÊûúÊòØinitProcessÔºåËøôÈáåÊòØconfig.json ÈáåÁöÑcommand
	//			process:       p,
	//			bootstrapData: data,
	//			container:     c,
	//		},
	//		intelRdtManager: c.intelRdtManager,
	//	}
	//	c.initProcess = init
}
return c.newSetnsProcess(p, cmd, comm)
//	proc := &amp;setnsProcess{
//		containerProcess: containerProcess{
//			cmd:           cmd, // runc init
//			comm:          comm, // Âá†‰∏™ÈÄö‰ø°ÁöÑuds
//			manager:       c.cgroupManager,
//			config:        c.newInitConfig(p),// ÈáåÈù¢ÊòØprocess Áî®Êà∑ËøõÁ®ãÁöÑÂëΩ‰ª§ÔºåÂ¶ÇÊûúÊòØsetnsProcessÔºåËøôÈáåÊòØ runc exec -it $container $command
//			process:       p,
//			bootstrapData: data,
//			container:     c,
//		},
//		cgroupPaths:     state.CgroupPaths,
//		rootlessCgroups: c.config.RootlessCgroups,
//		intelRdtPath:    state.IntelRdtPath,
//		initProcessPid:  state.InitProcessPid,
//	}
</code></pre>
<h2 id="container">Container</h2>
<p>Êàë‰ª¨ÁúãÁúã<code>container</code>ÊúâÂì™‰∫õÊìç‰ΩúÔºö</p>
<pre><code>// ÂêØÂä®ÂÆπÂô®Ôºå‰πüÂ∞±ÊòØÂêØÂä® parentProcessÔºåÂèØËÉΩÊòØ initProcess ‰πüÂèØËÉΩÊòØ setnsProcess (ÂÆû‰æãÂåñ‰∏Ä‰∏™processControlerÂêéÊãâËµ∑childProcess)
func (c *Container) Start(process *Process) error {}


func (c *Container) Run(process *Process) error {}
func (c *Container) Exec() error {}

// ËÆæÁΩÆÂÆπÂô®ÁöÑÈÖçÁΩÆÔºåÊØîÂ¶ÇcgroupÈÖçÁΩÆÔºàÂèØ‰ª•Áî®‰∫érunningÊÄÅÂÆπÂô®Ë∞ÉÊï¥ËµÑÊ∫êÔºâ
func (c *Container) Set(config configs.Config) error {}

// runcËøõÁ®ãÂàõÂª∫parentËøõÁ®ãÔºàparentËøõÁ®ãÂåÖÂê´‰∏§Áßç:initProcess Âíå setnsProcess Ôºâ
func (c *Container) newParentProcess(p *Process) (parentProcess, error) {}

// ÂÆπÂô®ÁöÑinitËøõÁ®ãÁöÑcontrollerÔºåÂΩìË∞ÉÁî®runc createÂêéË¢´Ë∞ÉÁî®ÔºåÂÆû‰æãÂåñÁöÑprocess controlerÂ∞ÜÊãâËµ∑Â≠êËøõÁ®ãÂêØÂä®initËøõÁ®ãÔºåÈöèÂêéÂéüÂú∞execÊàêÁî®Êà∑‰∏ªËøõÁ®ã
func (c *Container) newInitProcess(p *Process, cmd *exec.Cmd, comm *processComm) (*initProcess, error) {}

// ÂÆπÂô®ÁöÑsetnsËøõÁ®ãÁöÑcontrollerÔºåÂΩìË∞ÉÁî®runc exec $command ÂêéË¢´Ë∞ÉÁî®ÔºåÂÆû‰æãÂåñÁöÑprocess controlerÂ∞ÜÊãâËµ∑Â≠êËøõÁ®ãÂêØÂä®initËøõÁ®ãÔºåÈöèÂêéÂéüÂú∞execÊàê$commandËøõÁ®ã
func (c *Container) newSetnsProcess(p *Process, cmd *exec.Cmd, comm *processComm) (*setnsProcess, error) {}

</code></pre>
<h2 id="parentprocess">parentProcess</h2>
<p>parentProcess ÊòØ‰∏™interfaceÔºå ÂèØËÉΩÁöÑÂÆûÁé∞ÊòØinitProcessÊàñËÄÖsetnsProcess, ËøôÈáåÁöÑparentProcess ÂèØ‰ª•ÁêÜËß£Êàê‰∏Ä‰∏™process controllerÔºåË¥üË¥£ÊãâËµ∑Â≠êËøõÁ®ãÂπ∂ÂíåÂ≠êËøõÁ®ã‰∫§‰∫í„ÄÇ</p>
<pre><code>type parentProcess interface {
	// pid returns the pid for the running process.
	pid() int

	// start starts the process execution.
	start() error

	// send a SIGKILL to the process and wait for the exit.
	terminate() error

	// wait waits on the process returning the process state.
	wait() (*os.ProcessState, error)

	// startTime returns the process start time.
	startTime() (uint64, error)
	signal(os.Signal) error
	externalDescriptors() []string
	setExternalDescriptors(fds []string)
	forwardChildLogs() chan error
}
</code></pre>
<h3 id="initprocess-controller">initProcess Controller</h3>
<h4 id="parentprocess-1">parentProcess</h4>
<pre><code>// ÂêØÂä® `runc init` ËøõÁ®ã
// err := p.cmd.Start() 
// ‰º†ÈÄí NewNetlinkRequest, ËøôÈáå‰ΩøÁî®NetLinkÁªìÊûÑÔºåÂõ†‰∏∫netlinkÁªìÊûÑÊòØÂÜÖÊ†∏ÊîØÊåÅÁöÑÔºåÂêéÈù¢Ë∞ÉÁî®Á≥ªÁªüË∞ÉÁî®Êó∂‰ºöÊØîËæÉÊñπ‰æø
// if _, err := io.Copy(p.comm.initSockParent, p.bootstrapData); err != nil {
//    return fmt.Errorf(&quot;can't copy bootstrap data to pipe: %w&quot;, err)
// }
// ÈÄöËøáinitSockËé∑ÂèñÊúÄÁªàÂ≠êËøõÁ®ãinitProcessÁöÑpid ÔºàÂ≠êËøõÁ®ãÂú®cgoÈáåÈù¢ÁöÑnsexecÂáΩÊï∞ÈáåÈù¢ÁªèËøá‰∫ÜÂ§öÊ¨°cloneÔºåËøôÈáåÊãøÂà∞ÊúÄÁªàÁöÑÂ≠êËøõÁ®ãÔºâ
// childPid, err := p.getChildPid()
// Á≠âÂæÖÁõ¥Êé•Â≠êËøõÁ®ãÈÄÄÂá∫, ÁÑ∂ÂêéÂ∞Ü initProcess ËÆæÁΩÆ‰∏∫ÂæÖÁÆ°ÁêÜÁöÑÊúÄÁªàÂ≠êËøõÁ®ã
// if err := p.waitForChildExit(childPid); err != nil {
//   return fmt.Errorf(&quot;error waiting for our first child to exit: %w&quot;, err)
// }
// ÂØπchildPidÂàõÂª∫MountÈÖçÁΩÆÔºöËøôÈáåÁöÑrequestÊòØ‰∏™ÂæÄrequestChÂèëÈÄÅÊï∞ÊçÆÁöÑfnÔºåÂú® goCreateMountSources ‰∏≠ÂàõÂª∫‰∫ÜrequestChÔºåÂπ∂ÂºÇÊ≠•Ê∂àË¥πrequestChÁî®‰∫émount
// request, cancel, err := p.goCreateMountSources(context.Background())
// ÂØπchildPidÂàõÂª∫ÁΩëÁªúÈÖçÁΩÆ
// p.createNetworkInterfaces()
// ÂêëinitSock ÂèëÈÄÅÁî®Êà∑ËøõÁ®ãÁõ∏ÂÖ≥ÁöÑÈÖçÁΩÆÔºåÊØîÂ¶ÇÁî®Êà∑ËøõÁ®ãÁöÑÂêØÂä®ÂëΩ‰ª§
// utils.WriteJSON(p.comm.initSockParent, p.config)
// loop Â§ÑÁêÜÂ≠êËøõÁ®ãÂèëÈÄÅËøáÊù•ÁöÑ‰∏Ä‰∫õ‰ø°ÊÅØÔºåÊØîÂ¶Ç procMountPlease ËØ∑Ê±ÇÊåÇËΩΩË∑ØÂæÑÔºåprocSeccomp ÊöÇÊó∂Ê≤°ÁúãÊáÇÊòØÂú®Âπ≤ÂòõÔºå‰ºº‰πéÂè™ÊòØÂæÄ seccomp ÁöÑlistenerPathÂèëÈÄÅ‰∫ÜÁÇπ‰∏úË•øÔºå  procReady ‰ª£Ë°®container createdÊàêÂäüÔºå procHooks ‰ª£Ë°®runcÂèØ‰ª•ÊâßË°å‰∏Ä‰∫õhooks‰∫ÜÔºåÊØîÂ¶ÇPrestart„ÄÅCreateRuntime
// parseSync(p.comm.syncSockParent, func(sync *syncT) error {})
// ËØªÂà∞EOFÊàñÂ§ÑÁêÜerrorÂêéÔºåÂÖ≥Èó≠socketÂÜôÁ´ØÔºåËØªÁ´Ø‰ºöÊî∂Âà∞EOF
// p.comm.syncSockParent.Shutdown(unix.SHUT_WR)
func (p *initProcess) start() (retErr error) {}
</code></pre>
<h4 id="childprocessÁ´Ø">childProcessÁ´Ø</h4>
<p>runc‰ºöÂàõÂª∫Âá∫ <code>runc init</code> Â≠êËøõÁ®ã, Ëøô‰∏™ËøõÁ®ã‰ºöÂÖàË∞ÉÁî®cgoÈáåÈù¢ÁöÑnsexecÂáΩÊï∞, cloneÂá∫Â§ö‰∏™Â≠êËøõÁ®ãÔºàclone‰∫Ü‰∏§Ê¨°ÔºåÁî®‰∫ésetnsÁ≠âÔºâÔºåÊúÄÁªàÂ≠êËøõÁ®ã‰ºöË∞ÉÁî® <code>return system.Exec(name, l.config.Args, l.config.Env)</code> ÂéüÂú∞ÊâßË°åÁî®Êà∑Ëá™ÂÆö‰πâÂëΩ‰ª§„ÄÇ</p>
<pre><code>// ÂèØ‰ª•ÁúãÂà∞ `init` command Ê≤°ÊúâÊ≥®ÂÜåÂú®main.go, ËÄåÊòØÊ≥®ÂÜåÂú® init func Èáå
// ÂéüÂõ†ÂÖ∂ÂÆûÊØîËæÉÁÆÄÂçïÔºåÊòØÂõ†‰∏∫‰ΩøÁî®ÁöÑcliÂ∫ìÊ≤°ÊúâÊèê‰æõ‰∏ÄÁßçignoreÂèÇÊï∞ÔºåÂ¶ÇÊûúcliÂ∫ìÂÖÅËÆ∏Ê≥®ÂÜåÊüêÁßçcommandÔºå‰ΩÜÊòØ‰∏çÂ±ïÁ§∫Âú®help‰ø°ÊÅØÈáåÔºåÈÇ£‰πà‰Ωú‰∏∫ÂÜÖÈÉ®commandÁöÑinitÔºå‰πüÂèØ‰ª•Ê≥®ÂÜåÂú®main.go ÈáåÔºåËÄå‰∏çÁî®hackÂú®init func Èáå„ÄÇ
func init() {
	if len(os.Args) &gt; 1 &amp;&amp; os.Args[1] == &quot;init&quot; {
		// This is the golang entry point for runc init, executed
		// before main() but after libcontainer/nsenter's nsexec().
		libcontainer.Init()
	}
}

// libcontainer:
func Init() {
	runtime.GOMAXPROCS(1)
	runtime.LockOSThread()

	if err := startInitialization(); err != nil {
		// If the error is returned, it was not communicated
		// back to the parent (which is not a common case),
		// so print it to stderr here as a last resort.
		//
		// Do not use logrus as we are not sure if it has been
		// set up yet, but most important, if the parent is
		// alive (and its log forwarding is working).
		fmt.Fprintln(os.Stderr, err)
	}
	// Normally, StartInitialization() never returns, meaning
	// if we are here, it had failed.
	os.Exit(255) // ÂèØ‰ª•ÁúãÂà∞ËøôÈáåÁõ¥Êé•ÈÄÄÂá∫‰∫ÜÔºå‰∏ç‰ºöËøõÂÖ•main ÂáΩÊï∞
}

// Normally, this function does not return. If it returns, with or without an
// error, it means the initialization has failed. If the error is returned,
// it means the error can not be communicated back to the parent.
func startInitialization() (retErr error) {
	// Get the synchronisation pipe.
	envSyncPipe := os.Getenv(&quot;_LIBCONTAINER_SYNCPIPE&quot;)
	syncPipeFd, err := strconv.Atoi(envSyncPipe)
	if err != nil {
		return fmt.Errorf(&quot;unable to convert _LIBCONTAINER_SYNCPIPE: %w&quot;, err)
	}
	syncPipe := newSyncSocket(os.NewFile(uintptr(syncPipeFd), &quot;sync&quot;))
	defer syncPipe.Close()

	defer func() {
		// If this defer is ever called, this means initialization has failed.
		// Send the error back to the parent process in the form of an initError
		// if the sync socket has not been closed.
		if syncPipe.isClosed() {
			return
		}
		ierr := initError{Message: retErr.Error()}
		if err := writeSyncArg(syncPipe, procError, ierr); err != nil {
			fmt.Fprintln(os.Stderr, err)
			return
		}
		// The error is sent, no need to also return it (or it will be reported twice).
		retErr = nil
	}()

	// Get the INITPIPE.
	envInitPipe := os.Getenv(&quot;_LIBCONTAINER_INITPIPE&quot;)
	initPipeFd, err := strconv.Atoi(envInitPipe)
	if err != nil {
		return fmt.Errorf(&quot;unable to convert _LIBCONTAINER_INITPIPE: %w&quot;, err)
	}
	initPipe := os.NewFile(uintptr(initPipeFd), &quot;init&quot;)
	defer initPipe.Close()

	// Set up logging. This is used rarely, and mostly for init debugging.

	// Passing log level is optional; currently libcontainer/integration does not do it.
	if levelStr := os.Getenv(&quot;_LIBCONTAINER_LOGLEVEL&quot;); levelStr != &quot;&quot; {
		logLevel, err := strconv.Atoi(levelStr)
		if err != nil {
			return fmt.Errorf(&quot;unable to convert _LIBCONTAINER_LOGLEVEL: %w&quot;, err)
		}
		logrus.SetLevel(logrus.Level(logLevel))
	}

	logFd, err := strconv.Atoi(os.Getenv(&quot;_LIBCONTAINER_LOGPIPE&quot;))
	if err != nil {
		return fmt.Errorf(&quot;unable to convert _LIBCONTAINER_LOGPIPE: %w&quot;, err)
	}
	logPipe := os.NewFile(uintptr(logFd), &quot;logpipe&quot;)

	logrus.SetOutput(logPipe)
	logrus.SetFormatter(new(logrus.JSONFormatter))
	logrus.Debug(&quot;child process in init()&quot;)

	// Only init processes have FIFOFD.
	var fifoFile *os.File
	// ËøôÈáåinitType Â∞±‰∏§ÁßçÁ±ªÂûãÔºöstandard„ÄÅsetnsÔºåstarndardË°®Á§∫initProcess
	envInitType := os.Getenv(&quot;_LIBCONTAINER_INITTYPE&quot;)
	it := initType(envInitType)
	if it == initStandard {
		// fifofd ÊòØ exec.fifo Êñá‰ª∂ÔºåÊòØ‰∏™fifoÂëΩÂêçÁÆ°ÈÅìÔºåÁî®‰∫éÈÄöÁü•initProcess ÊòØÂê¶ÂèØ‰ª•Ë∞ÉÁî®system.exec ÊâßË°åÁî®Êà∑‰∏ªËøõÁ®ã
		fifoFd, err := strconv.Atoi(os.Getenv(&quot;_LIBCONTAINER_FIFOFD&quot;))
		if err != nil {
			return fmt.Errorf(&quot;unable to convert _LIBCONTAINER_FIFOFD: %w&quot;, err)
		}
		fifoFile = os.NewFile(uintptr(fifoFd), &quot;initfifo&quot;)
	}

	var consoleSocket *os.File
	if envConsole := os.Getenv(&quot;_LIBCONTAINER_CONSOLE&quot;); envConsole != &quot;&quot; {
		console, err := strconv.Atoi(envConsole)
		if err != nil {
			return fmt.Errorf(&quot;unable to convert _LIBCONTAINER_CONSOLE: %w&quot;, err)
		}
		consoleSocket = os.NewFile(uintptr(console), &quot;console-socket&quot;)
		defer consoleSocket.Close()
	}

	var pidfdSocket *os.File
	if envSockFd := os.Getenv(&quot;_LIBCONTAINER_PIDFD_SOCK&quot;); envSockFd != &quot;&quot; {
		sockFd, err := strconv.Atoi(envSockFd)
		if err != nil {
			return fmt.Errorf(&quot;unable to convert _LIBCONTAINER_PIDFD_SOCK: %w&quot;, err)
		}
		pidfdSocket = os.NewFile(uintptr(sockFd), &quot;pidfd-socket&quot;)
		defer pidfdSocket.Close()
	}

	// From here on, we don't need current process environment. It is not
	// used directly anywhere below this point, but let's clear it anyway.
	os.Clearenv()

	defer func() {
		if err := recover(); err != nil {
			if err2, ok := err.(error); ok {
				retErr = fmt.Errorf(&quot;panic from initialization: %w, %s&quot;, err2, debug.Stack())
			} else {
				retErr = fmt.Errorf(&quot;panic from initialization: %v, %s&quot;, err, debug.Stack())
			}
		}
	}()

	// Âú®ËøôÈáåÈòªÂ°ûËØªruncËøõÁ®ãÂèëÈÄÅËøáÊù•ÁöÑinitÊï∞ÊçÆÔºåÊØîÂ¶ÇÁî®Êà∑ËøõÁ®ãÂëΩ‰ª§Âï•ÁöÑ
	var config initConfig
	if err := json.NewDecoder(initPipe).Decode(&amp;config); err != nil {
		return err
	}

	// If init succeeds, it will not return, hence none of the defers will be called.
	return containerInit(it, &amp;config, syncPipe, consoleSocket, pidfdSocket, fifoFile, logPipe)
}
</code></pre>
<pre><code>i := &amp;linuxStandardInit{
	pipe:          pipe, // sync socket, Áî®‰∫éÂíå parentProcess(‰πüÂ∞±ÊòØrunc) ‰∫§‰∫í
	consoleSocket: consoleSocket, // console socket
	pidfdSocket:   pidfdSocket, // childProcess ÂàõÂª∫Âá∫Êù•Âêé, ÂèëÈÄÅchildProcessÁöÑpidÂà∞socketÔºåËøô‰∏™ÊòØÁî®Êà∑Ëá™Â∑±Âª∫Âá∫Êù•ÁöÑsocketÔºå‰∏çÊòØruncÂÜÖÈÉ®ÁöÑ„ÄÇÂú®parentProcess‰∏≠openÔºåÁªßÊâøÁªôchildProcess
	parentPid:     unix.Getppid(), // parentProcess(‰πüÂ∞±ÊòØrunc)ÁöÑpid
	config:        config, // ‰ªéinitPipe ËØªÂà∞ÁöÑconfig, ÂåÖÂê´Áî®Êà∑Ëá™ÂÆö‰πâÂëΩ‰ª§Á≠â‰ø°ÊÅØ
	fifoFile:      fifoFile, // exec.fifo Êñá‰ª∂, initProcess ÁâπÊúâÔºåÁî®‰∫é‰Ωú‰∏∫‰∏ÄÁßç‰ø°Âè∑ÈÄöÁü•ÔºåÂëäÁü•initProcessÂèØ‰ª•‰ªécreatedÂèòÊàêrunning(Âç≥Ë∞ÉÁî®system.exec ÂéüÂú∞ÊõøÊç¢ÊàêÁî®Êà∑‰∏ªËøõÁ®ã)
	logPipe:       logPipe, // Êó•ÂøópipeÔºåÊó•ÂøóÂ∞ÜË¢´parentProcessÊ∂àË¥π
}
</code></pre>
<h2 id="fdÁªßÊâø">fdÁªßÊâø</h2>
<p>Â¶ÇÊûúÈÄöËøá<code>fork</code>, ÈÇ£ÂΩìÁÑ∂Â∞±Áõ¥Êé•ÁªßÊâø‰∫ÜÊâìÂºÄÁöÑfdÔºåÂ¶ÇÊûúÊòØÈÄöËøá<code>*exec.Cmd</code>ÔºàÊàñËÄÖÂ∞±ÊòØ‰∏ÄËà¨ËØ¥ÁöÑË∞ÉÁî®Â≠êËøõÁ®ãÁöÑÊñπÂºèÔºàÊú¨Ë¥®‰∏äÊòØfork+execÔºâÔºâ, Âú®goËØ≠Ë®ÄÁöÑÂ§ÑÁêÜ‰∏äÔºåÊòØÈÄöËøá<code>cmd.ExtraFiles</code>, ÊØîÂ¶Ç <code>cmd.ExtraFiles = append(cmd.ExtraFiles, fifo)</code></p>
<pre><code>ExtraFiles specifies additional open files to be inherited by the new process. It does not include standard input, standard output, or standard error. If non-nil, entry i becomes file descriptor 3+i.

ExtraFiles is not supported on Windows.

field ExtraFiles []*os.File
</code></pre>
<p>Â≠êËøõÁ®ã‰ΩøÁî®ËØ•ÊèèËø∞Á¨¶Êó∂ÔºåÂÖ∂fdÁºñÂè∑‰ªé3ÂºÄÂßãÔºàÂõ†‰∏∫0„ÄÅ1„ÄÅ2ÊòØÂÜÖÁΩÆÁöÑÔºâÔºåÊØîÂ¶ÇExtraFiles[0]ÁöÑfdÊòØ3ÔºåExtraFiles[1]ÁöÑÁºñÂè∑ÊòØ4</p>
<p>ÂæàÊòæÁÑ∂ÔºåÊàë‰ª¨ÊØîËæÉÈöæÁü•ÈÅìExtraFiles[0]Âà∞Â∫ïÊòØ‰∏™Âï•ÔºåÊâÄ‰ª•runc‰∏≠‰ºöÈÄöËøáÁéØÂ¢ÉÂèòÈáè‰º†ÈÄíÔºö</p>
<pre><code>fifoName := filepath.Join(c.stateDir, execFifoFilename)
fifo, err := os.OpenFile(fifoName, unix.O_PATH|unix.O_CLOEXEC, 0)
cmd.ExtraFiles = append(cmd.ExtraFiles, fifo)
stdioFdCount := 3
cmd.Env = append(cmd.Env,
		&quot;_LIBCONTAINER_FIFOFD=&quot;+strconv.Itoa(stdioFdCount+len(cmd.ExtraFiles)-1))
</code></pre>
<p>Â≠êËøõÁ®ãÈÄöËøá<code>os.NewFile(fd, $name)</code>ÂæóÂà∞<code>*os.File</code>, name Èöè‰æøÂèñ„ÄÇ</p>
<pre><code>fifoFd, err := strconv.Atoi(os.Getenv(&quot;_LIBCONTAINER_FIFOFD&quot;))
if err != nil {
	return fmt.Errorf(&quot;unable to convert _LIBCONTAINER_FIFOFD: %w&quot;, err)
}
fifoFile = os.NewFile(uintptr(fifoFd), &quot;initfifo&quot;)
</code></pre>
<h1 id="start">start</h1>
<p>ÂΩìÊâßË°åcreateÂëΩ‰ª§Âêé, initProcess ‰ºöÈòªÂ°ûÂú® fifo ÁÆ°ÈÅì‰∏äÔºåÁõ¥Âà∞ÊúâÂè¶‰∏Ä‰∏™ËøõÁ®ãÊâìÂºÄÁÆ°ÈÅì</p>
<pre><code>fd, err := unix.Open(fifoPath, unix.O_WRONLY|unix.O_CLOEXEC, 0)
if err != nil {
	return &amp;os.PathError{Op: &quot;open exec fifo&quot;, Path: fifoPath, Err: err}
}
if _, err := unix.Write(fd, []byte(&quot;0&quot;)); err != nil {
	return &amp;os.PathError{Op: &quot;write exec fifo&quot;, Path: fifoPath, Err: err}
}

// ...

// ÊâßË°åÁî®Êà∑‰∏ªËøõÁ®ã
return system.Exec(name, l.config.Args, l.config.Env)
</code></pre>
<p>ÂΩìÊâßË°åstartÂëΩ‰ª§Êó∂Ôºå‰ΩúÁî®Âè™ÊòØÊâìÂºÄÂπ∂ËØªÂèñ‰∏Ä‰∏ã fifo ÁÆ°ÈÅìÔºàËøôÈáåÁöÑËØªÂèñÂÜÖÂÆπÊ≤°Âï•ÂÆûÈôÖ‰ø°ÊÅØÔºåÂèØËÉΩÊòØ‰∏∫‰∫ÜÂπ∂ÂèëËÄÉËôëÔºåÂ¶ÇÊûúÂπ∂ÂèëË∞ÉÁî®startÔºåÂâç‰∏Ä‰∏™‰ºöÊàêÂäüÔºåÂêé‰∏Ä‰∏™‰ºöÂ§±Ë¥•Ôºâ</p>
<pre><code>func (c *Container) exec() error {
// ...
	blockingFifoOpenCh := awaitFifoOpen(path)
// ...
}
</code></pre>
<h1 id="exec">exec</h1>
<p>Âú®runcÁöÑËÆæËÆ°‰∏≠ÔºåexecÂíåcreateÁöÑÂ∑ÆÂà´‰∏çÂ§ßÔºåÈÉΩÊúâparentProcessÂíåchildProcessÁöÑÊ¶ÇÂøµÔºåÂè™‰∏çËøá‰ªéparent/childProcessÁöÑÊÑè‰πâ‰∏äÂ∞ÜÔºå‰∏Ä‰∏™ÊòØinitProcessÔºå‰∏Ä‰∏™ÊòØsetnsProcess, ‰ΩÜÊØ´Êó†ÁñëÈóÆÔºåÊµÅÁ®ãÈÉΩÊòØÂ∑Æ‰∏çÂ§öÁöÑÔºåÂõ†‰∏∫initProcessÂ∞±ÊòØÊâßË°åÁî®Êà∑‰∏ªËøõÁ®ãÔºåsetnsProcessÂ∞±ÊòØÊâßË°åÁî®Êà∑Ëá™ÂÆö‰πâÂëΩ‰ª§„ÄÇ<br>
initProcessÈúÄË¶ÅÊâßË°åÊâÄÊúâÁöÑÂàùÂßãÂåñÊìç‰ΩúÔºåÊØîÂ¶ÇrootfsÔºåÂêÑÁßçnsÔºåÁΩëÁªúË∑ØÁî±Á≠âÔºåsetnsÂè™ÈúÄË¶ÅËøõÂÖ•ÂØπÂ∫îÁöÑnsÂç≥ÂèØ„ÄÇ</p>
<h1 id="nsexec">nsexec</h1>
<p>Âú®ÊãâËµ∑childProcessÁöÑËøáÁ®ã‰∏≠ÔºåÊúâ‰∏Ä‰∏™ÂæàÂÖ≥ÈîÆÁöÑÊäÄÊúØÔºå<code>nsexec()</code>, ËøôÊòØ‰∏Ä‰∏™cÂÜôÁöÑ‰ª£Á†Å, Áî®‰∫éÂú®Á®ãÂ∫èÂêØÂä®Êó∂Ëá™Âä®ËøõÂÖ•ÁâπÂÆöLinuxÂëΩÂêçÁ©∫Èó¥„ÄÇ
ÂèØ‰ª•ÁúãÂà∞ÔºåcgoÁöÑinitÂáΩÊï∞ÈáåÊâßË°å‰∫Ü <code>nsexec()</code>, Ëøô‰∏™ <code>nsexec()</code> Â∞Ü‰ºöÂú® go ÁöÑÊâÄÊúâ‰ª£Á†ÅÔºàÂÖ®Â±ÄÂèòÈáè„ÄÅinitÂáΩÊï∞„ÄÅmainÂáΩÊï∞Ôºâ‰πãÂâçÊâßË°åÔºå</p>
<blockquote>
<p><strong>attribute</strong>((constructor)) ÊòØGCCÁâπÊÄßÔºåÊ†áËÆ∞ init() ÂáΩÊï∞Âú® ‚ÄãÂÖ±‰∫´Â∫ìÂä†ËΩΩÊó∂Ëá™Âä®ÊâßË°å„ÄÇ
ÂΩìGoÁ®ãÂ∫èÂêØÂä®Êó∂ÔºåC‰ª£Á†Å‰Ωú‰∏∫ÂÖ±‰∫´Â∫ìÂä†ËΩΩÔºåinit() ‰ºöÁ´ãÂç≥Ë∞ÉÁî® nsexec()</p></blockquote>
<pre><code>//go:build linux &amp;&amp; !gccgo

package nsenter

/*
#cgo CFLAGS: -Wall
extern void nsexec();
void __attribute__((constructor)) init(void) {
	nsexec();
}
*/
import &quot;C&quot;

</code></pre>
<p>ÂΩìÊ≠£Â∏∏‰ΩøÁî® runc Êó∂Ôºånsexec‰ºöÁõ¥Êé•ÈÄÄÂá∫Ôºö</p>
<pre><code>pipenum = getenv_int(&quot;_LIBCONTAINER_INITPIPE&quot;);
if (pipenum &lt; 0) {
	/* We are not a runc init. Just return to go runtime. */
	return;
}
</code></pre>
<p>ÂΩìÊâßË°å<code>runc init</code>Êó∂Ôºå‰πüÂ∞±ÊòØchildProcessÊó∂ÔºånsexecÊ≠£Â∏∏ÊâßË°åÔºå ÂÆåÊàê‰∫Ü childProcess ÁöÑnsËÆæÁΩÆ(<code>err = setns(ns-&gt;fd, type);</code>)ÔºåÂπ∂ËøõË°å‰∫ÜÂ§öÊ¨°cloneÔºö</p>
<pre><code>// ÂΩìÂâçÂú®stage-0 ËøõÁ®ã

// ÂàùÂßãÂåñÂá†‰∏™pipe
int sync_child_pipe[2], sync_grandchild_pipe[2];
socketpair(AF_LOCAL, SOCK_STREAM, 0, sync_child_pipe)
socketpair(AF_LOCAL, SOCK_STREAM, 0, sync_grandchild_pipe)

switch (setjmp(env)) {
case STAGE_PARENT:{
	// Â≠êËøõÁ®ãÁõ¥Êé•Ë∑≥Âà∞ STAGE_CHILD ÊâßË°å
	// CLONE_PARENT ÂèÇÊï∞Ë°®Á§∫cloneÂá∫ÂÖÑÂºüËøõÁ®ãÔºåËÄåÈùûÂ≠êËøõÁ®ã
	stage1_pid = clone(()=&gt;{longjmp(env, STAGE_CHILD)}, ca.stack_ptr, CLONE_PARENT | SIGCHLD, &amp;ca); 
	
	syncfd = sync_child_pipe[1];
	close(sync_child_pipe[0])

	stage1_complete = false;
	while (!stage1_complete) {
		// Â§ÑÁêÜ syncfd ‰º†ÈÄíËøáÊù•ÁöÑ stage-1 ÁöÑ:
		// 1. SYNC_USERMAP_PLS(Êõ¥Êñ∞ËøõÁ®ãÁöÑuid/gid map: e.g. write_file(map, map_len, &quot;/proc/%d/gid_map&quot;, pid)) 
		// 2. SYNC_RECVPID_PLS(Êî∂Âà∞stage-1ËøõÁ®ãÂèëÈÄÅÊù•ÁöÑstage2_pid) , Âπ∂Â∞Üstage1_pid, stage2_pid ÂèëÈÄÅÁªôinitPipe, Âú®parentProcess‰∏≠‰ºöwait stage0_pid/stage1_pid, Âπ∂Â∞ÜÁúüÂÆûÁöÑpidËÆæÁΩÆ‰∏∫stage2_pid
		// 3. SYNC_TIMEOFFSETS_PLS ËÆæÁΩÆÂÆπÂô®Êó∂Èó¥Áõ∏ÂØπÁâ©ÁêÜÊú∫ÁöÑÂÅèÁßªÈáèÔºåËøôÊòØ‰∏ÄÁßçtime namepsace
		// 4. SYNC_CHILD_FINISHÔºöstage1_complete=true
	}

	syncfd = sync_grandchild_pipe[1];
	close(sync_grandchild_pipe[0])
	stage2_complete = false;
	while (!stage2_complete) {
		// Âêë stage-2 ÂèëÈÄÅ‰ø°ÊÅØ

		s = SYNC_GRANDCHILD;
		write(syncfd, &amp;s, sizeof(s))
		read(syncfd, &amp;s, sizeof(s))
		if (s != SYNC_CHILD_FINISH){failed}
	}

	// stage-0 ËøõÁ®ãÈÄÄÂá∫
	exit(0);
}
case STAGE_CHILD:{
	// ÂΩìÂâçÂú®stage-1ËøõÁ®ã

	syncfd = sync_child_pipe[0];
	close(sync_child_pipe[1])

	join_namespaces(config.namespaces)

	if (config.cloneflags &amp; CLONE_NEWUSER) {
		try_unshare(CLONE_NEWUSER, &quot;user namespace&quot;); // Â¶ÇÊûúÊòØrootlessÊ®°ÂºèÔºåÁî®unshareÂ∞ÜÂΩìÂâçËøõÁ®ãÁßªÂÖ• user namespace ÔºàÂ¶ÇÊûúÊòØËÆ©Â≠êËøõÁ®ãËøõÂÖ•user namespaceÔºåÊääCLONE_NEWUSER‰º†ÁªôcloneÂ∞±Ë°åÔºâ
		
		// ...
		
		// ËØ∑Ê±Çstage-0 ËøõË°å user mappingÔºå Âõ†‰∏∫stage-1 ËøõÁ®ãÊ≤°ÊùÉÈôêÔºàÂÖ∑‰Ωì‰∏∫Âï•Ê≤°ÊùÉÈôê‰∏çÊ∏ÖÊ•öÔºåÁúãÊ∫êÁ†ÅÊ≥®ÈáäÊòØÂíåCLONE_PARENTÊúâÂÖ≥Ôºâ
		s = SYNC_USERMAP_PLS;
		write(syncfd, &amp;s, sizeof(s))
		read(syncfd, &amp;s, sizeof(s))
		if (s != SYNC_USERMAP_ACK){failed}

		// ...

		setresuid(0, 0, 0) // Â∞ÜÂΩìÂâçËøõÁ®ã‰Ωú‰∏∫nsÈáåÁöÑrootÔºå‰πüÂ∞±ÊòØuid=0
	}

	try_unshare(config.cloneflags, &quot;remaining namespaces&quot;); // Ê≥®ÈáäÈáåÊúâÊèêÂà∞ÔºåÊüê‰∫õÂÜÖÊ†∏ÁöÑcloneÂØπ‰∏Ä‰∫õÂèÇÊï∞ÁöÑËÅîÂêà‰ΩøÁî®ÊúâÁÇπÈóÆÈ¢òÔºåÊâÄ‰ª•Âú®ËøôÈáåunshare„ÄÇ
	// ÂΩìunshare CLONE_PID Êó∂ÔºåÂΩìÂâçËøõÁ®ãÁöÑpid‰ªçÂú®Âéüpid nsÔºåÂÖ∂Â≠êËøõÁ®ãÂú®Êñ∞ÁöÑpid namespace, pid = 1

	
	// ...

	// Â≠êËøõÁ®ãÁõ¥Êé•Ë∑≥Âà∞ STAGE_INIT ÊâßË°å
	stage2_pid = clone(()=&gt;{longjmp(env, STAGE_INIT)}, ca.stack_ptr, CLONE_PARENT | SIGCHLD, &amp;ca);

	s = SYNC_RECVPID_PLS
	write(syncfd, &amp;s, sizeof(s))
	write(syncfd, &amp;stage2_pid, sizeof(stage2_pid))
	read(syncfd, &amp;s, sizeof(s))
	if (s != SYNC_RECVPID_ACK){failed}

	s = SYNC_CHILD_FINISH;
	write(syncfd, &amp;s, sizeof(s))

	// stage-1 ËøõÁ®ãÈÄÄÂá∫
	exit(0);
}
case STAGE_INIT:{
	syncfd = sync_grandchild_pipe[0];
	close(sync_grandchild_pipe[1]) 
	close(sync_child_pipe[0])

	read(syncfd, &amp;s, sizeof(s))
	if (s != SYNC_GRANDCHILD){failed}

	setsid()
	setuid(0)
	setgid(0)

	s = SYNC_CHILD_FINISH;
	write(syncfd, &amp;s, sizeof(s))
	close(sync_grandchild_pipe[0])
	return;
}
}
</code></pre>
<h1 id="fs-mount">FS mount</h1>
<p>ËøôÈáåËÆ≤‰∏Ä‰∏ãÊñá‰ª∂ÊàñËÄÖrootfsÊòØÊÄé‰πàÊåÇËΩΩÁöÑ</p>
<p>È¶ñÂÖàÔºårunc bundleË¶ÅÊ±ÇÊàë‰ª¨Â∑≤ÁªèÂáÜÂ§áÂ•Ω‰∫Ü‰∏Ä‰∏™rootfsÔºåÂÖ∂Ê¨°ÔºåÊàë‰ª¨ËøõÂÖ•‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑmount namespace„ÄÇ</p>
<h2 id="rootfs">rootfs</h2>
<ol>
<li>ÂØπrootfsÁöÑmountÂèØ‰ª•ÈÄöËøáchrootÊàñËÄÖpivotroot
<ol>
<li>Â¶ÇÊûúÊ≤°ÊúâÊåáÂÆö new mount namespace, ÈÇ£Â∞±Áõ¥Êé•chroot: unix.Chroot(&quot;.&quot;); unix.Chdir(&quot;/&quot;); (ËøôÈáåÂêéÈù¢ÂÜçË∞ÉÁî®‰∏ÄÊ¨°chdirÔºåÈÅøÂÖçrootfsÂàáÊç¢ÂêéË∑ØÂæÑÊ≤°ÂØπÈΩê)</li>
<li>‰∏ÄËà¨Êù•ËØ¥ÔºåÈÉΩÊåáÂÆö‰∫Ünew mount namespaceÔºåËøôÊó∂‰ΩøÁî® unix.PivotRoot(&quot;.&quot;, &ldquo;.&quot;)Ôºå‰∏≠Èó¥Êúâ‰∏Ä‰∫õÂ§çÊùÇÁöÑÂÜÖÊ†∏Â±ÇÈù¢ÁöÑtrickÔºåÁúã‰∫Ü‰∏Ä‰∫õissue‰πüÊ≤°Â§™ÁúãÊáÇÔºåËøôÈáå‰∏çËµòËø∞‰∫Ü„ÄÇ</li>
</ol>
</li>
</ol>
<h2 id="bind-mount">bind mount</h2>
<p>ÂØπ‰∫éÂ∏∏ËßÅÁöÑÊñá‰ª∂/ÁõÆÂΩïÊåÇËΩΩÔºåÈÉΩÊòØÈÄöËøámount -o bind.<br>
È¶ñÂÖàÂú®ÁõÆÊ†áÊåÇËΩΩÁõÆÂΩïÂàõÂª∫‰∏Ä‰∏™ÊåÇËΩΩÁÇπÔºö</p>
<pre><code>destDir, destBase := filepath.Split(dest)
destDirFd, err := utils.MkdirAllInRootOpen(rootfs, destDir, 0o755)
unix.Mknodat(int(destDirFd.Fd()), destBase, unix.S_IFREG|0o644, 0)
</code></pre>
<p>ÈöèÂêéÂ∞ÜÂØπÂ∫îÊñá‰ª∂ÊàñÁõÆÂΩïÁöÑfdÂØπÂ∫îÁöÑÊñá‰ª∂ÔºàÂΩ¢Â¶Ç /proc/self/fd/111Ôºâ ÊåÇÂú®ÁõÆÊ†áÁöÑfdÔºàÂΩ¢Â¶Ç /proc/self/fd/112Ôºâ‰∏äÔºö
unix.Mount(src, dst, fstype, flags, data)</p>
<h1 id="console-io">Console IO</h1>
<p>ttyÊòØÊÄé‰πàÂàõÂª∫ÁöÑÔºå‰ª•ÂèäÊÄé‰πàÁîüÊïàÁöÑÔºåÂç≥ÊÄé‰πàÊääÊüê‰∏™ËøõÁ®ãÁöÑstdioÂÖ≥ËÅîÂà∞ÁªàÁ´ØÁöÑstdioÔºü</p>
<blockquote>
<p>Â¶ÇÊûúÊàë‰ª¨Áõ¥Êé•Âú®ÂâçÂè∞Ë∞ÉÁî®Êüê‰∏™ËøõÁ®ãÔºåÂÄíÊòØ‰∏çÁî®ÊãÖÂøÉttyÁöÑÈóÆÈ¢òÔºåÈÉΩ‰ºöËá™Âä®ÁªßÊâøttyÁöÑioÔºå‰ΩÜÂ¶ÇÊûúÊòØdockerd/containerd ËøôÁßçdaemonÂú∫ÊôØÂë¢Ôºü</p></blockquote>
<h2 id="mount">mount</h2>
<p>ÈÄöËøáÊâìÂºÄ <code>f = os.OpenFile(&quot;/dev/ptmx&quot;, unix.O_RDWR|unix.O_NOCTTY|unix.O_CLOEXEC, 0)</code> Êñá‰ª∂ÔºåÂ∞±‰ºöÊãøÂà∞‰∏Ä‰∏™ttyÁöÑfdÔºåÈÄöËøá <code>unix.Syscall(unix.SYS_IOCTL, f.Fd(), &amp;u, ...)</code> Á≥ªÁªüË∞ÉÁî®ÔºåÊãøÂà∞ÂØπÂ∫îÁöÑÂàõÂª∫Âá∫Êù•ÁöÑttyÁöÑÊñá‰ª∂Âú∞ÂùÄ<code>fmt.Sprintf(&quot;/dev/pts/%d&quot;, u)</code>Ôºå ÈöèÂêéÔºåÂ∞ÜttyÁöÑÊñá‰ª∂Âú∞ÂùÄmountÂà∞ <code>/dev/console</code>, ÈöèÂêéÊâìÂºÄslavepathÔºåÂ∞ÜÂØπÂ∫îÁöÑfd dupÂà∞ 0„ÄÅ1„ÄÅ2 ‰∏äÔºåËøôÊÑèÂë≥ÁùÄÂØπ0/1/2ÁöÑÈáçÂÆöÂêë</p>
<p>Âú®ËøôÈáåÔºåÂ≠òÂú®consoleÁöÑmasterÂíåslaveÔºåmasterÂ∞±ÊòØÊâìÂºÄ <code>/dev/ptmx</code> ÂæóÂà∞ÁöÑfdÔºå slaveÂ∞±ÊòØ <code>unix.Syscall(unix.SYS_IOCTL</code> ÂæóÂà∞ÁöÑ fd</p>
<blockquote>
<p>‚ÄãMaster ‚Üí SlaveÔºöÊéßÂà∂Á´ØÔºàÂ¶ÇÁî®Êà∑ÈîÆÁõòËæìÂÖ•ÔºâÂèëÈÄÅÊï∞ÊçÆÂà∞Ë¢´ÊéßËøõÁ®ã„ÄÇ
‚ÄãSlave ‚Üí MasterÔºöË¢´ÊéßËøõÁ®ãÁöÑËæìÂá∫ÔºàÂ¶ÇÂëΩ‰ª§ÁªìÊûúÔºâËøîÂõûÁªôÊéßÂà∂Á´Ø„ÄÇ
Master/Slave ‰πãÈó¥ÁöÑÊï∞ÊçÆÊã∑Ë¥ùÊòØÂÜÖÊ†∏Ëá™Âä®ÂÆåÊàêÁöÑÔºåÂü∫Êú¨‰∏äÊù•ËØ¥ÔºåÂè™Ë¶ÅÊüê‰∏™Ë¢´ÊéßËøõÁ®ãÁöÑstdioË¢´ÈáçÂÆöÂêëÂà∞slaveÔºåÂ∞±Ê≠£Â∏∏ÂÖ≥ËÅîÂà∞consoleÁöÑstdio‰∫Ü„ÄÇÊàë‰ª¨Êìç‰ΩúÁöÑÁõÆÁöÑÁöÑÊú¨Ë¥®Â∞±ÊòØÊÄé‰πàÊääÊüê‰∏™ËøõÁ®ãÁöÑstdioÂÖ≥ËÅîÂà∞ÁªàÁ´ØÁöÑstdio„ÄÇ</p></blockquote>
<pre><code>Âú® new mount namespace ÈáåÈù¢ÊâßË°å


// setupConsole sets up the console from inside the container, and sends the
// master pty fd to the config.Pipe (using cmsg). This is done to ensure that
// consoles are scoped to a container properly (see runc#814 and the many
// issues related to that). This has to be run *after* we've pivoted to the new
// rootfs (and the users' configuration is entirely set up).
func setupConsole(socket *os.File, config *initConfig, mount bool) error {
	defer socket.Close()
	// At this point, /dev/ptmx points to something that we would expect. We
	// used to change the owner of the slave path, but since the /dev/pts mount
	// can have gid=X set (at the users' option). So touching the owner of the
	// slave PTY is not necessary, as the kernel will handle that for us. Note
	// however, that setupUser (specifically fixStdioPermissions) *will* change
	// the UID owner of the console to be the user the process will run as (so
	// they can actually control their console).

	pty, slavePath, err := console.NewPty()
	if err != nil {
		return err
	}
	// After we return from here, we don't need the console anymore.
	defer pty.Close()

	if config.ConsoleHeight != 0 &amp;&amp; config.ConsoleWidth != 0 {
		err = pty.Resize(console.WinSize{
			Height: config.ConsoleHeight,
			Width:  config.ConsoleWidth,
		})
		if err != nil {
			return err
		}
	}

	// Mount the console inside our rootfs.
	if mount {
		if err := mountConsole(slavePath); err != nil {
			return err
		}
	}
	// While we can access console.master, using the API is a good idea.
	if err := utils.SendRawFd(socket, pty.Name(), pty.Fd()); err != nil {
		return err
	}
	runtime.KeepAlive(pty)

	// Now, dup over all the things.
	return dupStdio(slavePath)
}

// NewPty creates a new pty pair
// The master is returned as the first console and a string
// with the path to the pty slave is returned as the second
func NewPty() (Console, string, error) {
	f, err := openpt()
	if err != nil {
		return nil, &quot;&quot;, err
	}
	slave, err := ptsname(f)
	if err != nil {
		return nil, &quot;&quot;, err
	}
	if err := unlockpt(f); err != nil {
		return nil, &quot;&quot;, err
	}
	m, err := newMaster(f)
	if err != nil {
		return nil, &quot;&quot;, err
	}
	return m, slave, nil
}

// openpt allocates a new pseudo-terminal by opening the /dev/ptmx device
func openpt() (*os.File, error) {
	return os.OpenFile(&quot;/dev/ptmx&quot;, unix.O_RDWR|unix.O_NOCTTY|unix.O_CLOEXEC, 0)
}

// dupStdio opens the slavePath for the console and dups the fds to the current
// processes stdio, fd 0,1,2.
func dupStdio(slavePath string) error {
	fd, err := unix.Open(slavePath, unix.O_RDWR, 0)
	if err != nil {
		return &amp;os.PathError{
			Op:   &quot;open&quot;,
			Path: slavePath,
			Err:  err,
		}
	}
	for _, i := range []int{0, 1, 2} {
		if err := unix.Dup3(fd, i, 0); err != nil {
			return err
		}
	}
	return nil
}


// mount initializes the console inside the rootfs mounting with the specified mount label
// and applying the correct ownership of the console.
func mountConsole(slavePath string) error {
	f, err := os.Create(&quot;/dev/console&quot;)
	if err != nil &amp;&amp; !os.IsExist(err) {
		return err
	}
	if f != nil {
		// Ensure permission bits (can be different because of umask).
		if err := f.Chmod(0o666); err != nil {
			return err
		}
		f.Close()
	}
	return mount(slavePath, &quot;/dev/console&quot;, &quot;bind&quot;, unix.MS_BIND, &quot;&quot;)
}
</code></pre>

    </div>
    <div class="article-footer">
<blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    <li class="post-copyright-link hidden-xs">
      <strong>Permalink: </strong>
      <a href="https://wymli.github.io/2025/03/container-6.%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80%E4%B9%8Brunc%E6%BA%90%E7%A0%81/" title="[container] 6.ÂÆπÂô®Âü∫Á°Ä‰πãruncÊ∫êÁ†Å" target="_blank" rel="external">https://wymli.github.io/2025/03/container-6.%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80%E4%B9%8Brunc%E6%BA%90%E7%A0%81/</a>
    </li>
    <li class="post-copyright-license">
      <strong>License: </strong>
        <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN</a>
    </li>
  </ul>
</blockquote>

<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/wymli" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="https://wymli.github.io/me.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/wymli" target="_blank"><span class="text-dark">Li Weiming</span><small class="ml-1x">wymli@sysu.cse</small></a></h3>
        <div>ONE CAN GO FAST</div>
      </div>
    </figure>
  </div>
</div>

    </div>
  </article>
</div><nav class="bar bar-footer clearfix" data-stick-bottom>
    <div class="bar-inner">
        <ul class="pager pull-left">
            <li class="prev">
                <a href="https://wymli.github.io/2025/03/container-5.%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80%E4%B9%8Boci-dist/" title="[container] 5.ÂÆπÂô®Âü∫Á°Ä‰πãoci dist"><i
                        class="icon icon-angle-left"
                        aria-hidden="true"></i><span>&nbsp;&nbsp;Older</span></a>
            </li>
            <li class="next">
                <a href="https://wymli.github.io/2025/03/worklfow-1.-airflow/"
                    title="[airflow] airflow"><span>Newer&nbsp;&nbsp;</span><i
                        class="icon icon-angle-right" aria-hidden="true"></i></a>
            </li>
            
            <li class="toggle-toc">
                <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false"
                    title="Catalogue" role="button">
                    <span>[&nbsp;</span><span>Catalogue</span>
                    <i class="text-collapsed icon icon-anchor"></i>
                    <i class="text-in icon icon-close"></i>
                    <span>]</span>
                </a>
            </li>
        </ul>
        <div class="bar-right">
            <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter"
                data-mobile-sites="weibo,qq,qzone"></div>
        </div>
    </div>
</nav>


</main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
<ul class="social-links">
    <li><a href="https://github.com/wymli" target="_blank" title="github" data-toggle=tooltip data-placement=top >
            <i class="icon icon-github"></i></a></li>
    <li><a href="https://wymli.github.io/index.xml" target="_blank" title="rss" data-toggle=tooltip data-placement=top >
            <i class="icon icon-rss"></i></a></li>
</ul>
  <div class="copyright">
    &copy;2021  -
    2025
    <div class="publishby">
        Theme by <a href="https://github.com/xiaoheiAh" target="_blank"> xiaoheiAh </a>base on<a href="https://github.com/xiaoheiAh/hugo-theme-pure" target="_blank"> pure</a>.
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
            showMathMenu: false, //disables context menu
            tex2jax: {
            inlineMath: [ ['$','$'], ['\\(','\\)'] ]
           }
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    window.jQuery || document.write('\x3Cscript src="js/jquery.min.js"><\/script>')
</script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/python.min.js" defer></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/javascript.min.js" defer></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/go.min.js" defer></script><script>
    hljs.configure({
        tabReplace: '    ', 
        classPrefix: ''     
        
    })
    hljs.initHighlightingOnLoad();
</script>
<script src="https://wymli.github.io/js/application.min.e4989ab4dc212027af8773861b05b6bc333a1217f6b0a1b3377a3a3dbd454483.js"></script>
<script src="https://wymli.github.io/js/plugin.min.353ef3573cf0beb9b69d43450140ff59f497f732396f539052fc4973c6330fdb.js"></script>

<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            ROOT_URL: 'https:\/\/wymli.github.io\/',
            CONTENT_URL: 'https:\/\/wymli.github.io\/\/searchindex.json ',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script type="text/javascript" src="https://wymli.github.io/js/insight.min.716b0c6a00b68ccc31a2b65345f3412f4246ffa94a90f8e25d525528b4504f9937880692bbe619023233caba5d0a17ebe23d7cfb57cd3a88f23ea337ad5e4d00.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3',
        
        hasInnerContainers: true,
    });
</script>



  </body>
</html>
