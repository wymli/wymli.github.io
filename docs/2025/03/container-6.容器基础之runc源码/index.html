<!DOCTYPE html>
<html lang="en">
  <head>
    <title>
        [container] 6.å®¹å™¨åŸºç¡€ä¹‹runcæºç  - UnderTheHood
      </title>
        <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    
    <meta name="theme-color" content="#000000" />
    
    <meta http-equiv="window-target" content="_top" />
    
    
    <meta name="description" content="git clone https://github.com/opencontainers/runc.git, æˆ‘ä»¬ç®€å•é˜…è¯»ä¸‹ï¼Œä»£ç ä¸å¤š
å…¥å£ å…¥å£æ²¡å•¥å¥½è¯´çš„ï¼Œå…ˆæ‰¾main.goæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°runcè¿™ä¸ªåº“ç”¨äº† github.com/urfave/cli è¿™ä¸ªå‘½ä»¤è¡Œåº“å’Œ github.com/sirupsen/logrus è¿™ä¸ªæ—¥å¿—åº“ï¼Œèƒ½åœ¨è¿™ç§æ¯”è¾ƒé‡è¦çš„å·¥å…·é‡Œé¢ä½¿ç”¨ï¼Œè¯´æ˜è¿™ä¸¤ä¸ªåº“æ˜¯å¾ˆä¸é”™çš„ã€‚
" />
    <meta name="generator" content="Hugo 0.145.0 with theme pure" />
    <title>[container] 6.å®¹å™¨åŸºç¡€ä¹‹runcæºç  - UnderTheHood</title>
    
    
    <link rel="stylesheet" href="https://wymli.github.io/css/style.min.31c841d028bbb1b4f57eadc51e8f652fb1d4f783171c15f4f5de039708e133b3.css">
    
    <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/9.15.10/styles/github.min.css" async>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css" async>
    <meta property="og:url" content="https://wymli.github.io/2025/03/container-6.%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80%E4%B9%8Brunc%E6%BA%90%E7%A0%81/">
  <meta property="og:site_name" content="UnderTheHood">
  <meta property="og:title" content="[container] 6.å®¹å™¨åŸºç¡€ä¹‹runcæºç ">
  <meta property="og:description" content="git clone https://github.com/opencontainers/runc.git, æˆ‘ä»¬ç®€å•é˜…è¯»ä¸‹ï¼Œä»£ç ä¸å¤š
å…¥å£ å…¥å£æ²¡å•¥å¥½è¯´çš„ï¼Œå…ˆæ‰¾main.goæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°runcè¿™ä¸ªåº“ç”¨äº† github.com/urfave/cli è¿™ä¸ªå‘½ä»¤è¡Œåº“å’Œ github.com/sirupsen/logrus è¿™ä¸ªæ—¥å¿—åº“ï¼Œèƒ½åœ¨è¿™ç§æ¯”è¾ƒé‡è¦çš„å·¥å…·é‡Œé¢ä½¿ç”¨ï¼Œè¯´æ˜è¿™ä¸¤ä¸ªåº“æ˜¯å¾ˆä¸é”™çš„ã€‚">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-03-14T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-03-14T00:00:00+00:00">
    <meta property="article:tag" content="Container">
    <meta property="article:tag" content="Oci">
    <meta property="article:tag" content="Runc">

  <meta itemprop="name" content="[container] 6.å®¹å™¨åŸºç¡€ä¹‹runcæºç ">
  <meta itemprop="description" content="git clone https://github.com/opencontainers/runc.git, æˆ‘ä»¬ç®€å•é˜…è¯»ä¸‹ï¼Œä»£ç ä¸å¤š
å…¥å£ å…¥å£æ²¡å•¥å¥½è¯´çš„ï¼Œå…ˆæ‰¾main.goæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°runcè¿™ä¸ªåº“ç”¨äº† github.com/urfave/cli è¿™ä¸ªå‘½ä»¤è¡Œåº“å’Œ github.com/sirupsen/logrus è¿™ä¸ªæ—¥å¿—åº“ï¼Œèƒ½åœ¨è¿™ç§æ¯”è¾ƒé‡è¦çš„å·¥å…·é‡Œé¢ä½¿ç”¨ï¼Œè¯´æ˜è¿™ä¸¤ä¸ªåº“æ˜¯å¾ˆä¸é”™çš„ã€‚">
  <meta itemprop="datePublished" content="2025-03-14T00:00:00+00:00">
  <meta itemprop="dateModified" content="2025-03-14T00:00:00+00:00">
  <meta itemprop="wordCount" content="8564">
  <meta itemprop="keywords" content="Container,Oci,Runc">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="[container] 6.å®¹å™¨åŸºç¡€ä¹‹runcæºç ">
  <meta name="twitter:description" content="git clone https://github.com/opencontainers/runc.git, æˆ‘ä»¬ç®€å•é˜…è¯»ä¸‹ï¼Œä»£ç ä¸å¤š
å…¥å£ å…¥å£æ²¡å•¥å¥½è¯´çš„ï¼Œå…ˆæ‰¾main.goæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°runcè¿™ä¸ªåº“ç”¨äº† github.com/urfave/cli è¿™ä¸ªå‘½ä»¤è¡Œåº“å’Œ github.com/sirupsen/logrus è¿™ä¸ªæ—¥å¿—åº“ï¼Œèƒ½åœ¨è¿™ç§æ¯”è¾ƒé‡è¦çš„å·¥å…·é‡Œé¢ä½¿ç”¨ï¼Œè¯´æ˜è¿™ä¸¤ä¸ªåº“æ˜¯å¾ˆä¸é”™çš„ã€‚">

    <!--[if lte IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
      <![endif]-->

    <!--[if lt IE 9]>
        <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
      <![endif]-->
  </head>

  
  

  <body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="slimContent">
      <div class="navbar-header">
        <div class="profile-block text-center">
          <a id="avatar" href="https://github.com/wymli" target="_blank">
            <img class="img-circle img-rotate" src="https://wymli.github.io/me.jpg" width="200" height="200">
          </a>
          <h2 id="name" class="hidden-xs hidden-sm">Li Weiming</h2>
          <h3 id="title" class="hidden-xs hidden-sm hidden-md">wymli@sysu.cse</h3>
          <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>Guangzhou, China</small>
        </div><div class="search" id="search-form-wrap">
    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i
                        class="icon icon-search"></i></button>
            </span>
        </div>
        <div class="ins-search">
            <div class="ins-search-mask"></div>
            <div class="ins-search-container">
                <div class="ins-input-wrapper">
                    <input type="text" class="ins-search-input" placeholder="Type something..."
                        x-webkit-speech />
                    <button type="button" class="close ins-close ins-selectable" data-dismiss="modal"
                        aria-label="Close"><span aria-hidden="true">Ã—</span></button>
                </div>
                <div class="ins-section-wrapper">
                    <div class="ins-section-container"></div>
                </div>
            </div>
        </div>
    </form>
</div>
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
        <ul class="nav navbar-nav main-nav">
            <li class="menu-item menu-item-home">
                <a href="/">
                    <i class="icon icon-home-fill"></i>
                  <span class="menu-title">Home</span>
                </a>
            </li>
            <li class="menu-item menu-item-archives">
                <a href="/posts/">
                    <i class="icon icon-archives-fill"></i>
                  <span class="menu-title">Archives</span>
                </a>
            </li>
            <li class="menu-item menu-item-categories">
                <a href="/categories/">
                    <i class="icon icon-folder"></i>
                  <span class="menu-title">Categories</span>
                </a>
            </li>
            <li class="menu-item menu-item-tags">
                <a href="/tags/">
                    <i class="icon icon-tags"></i>
                  <span class="menu-title">Tags</span>
                </a>
            </li>
            <li class="menu-item menu-item-about">
                <a href="/about/">
                    <i class="icon icon-cup-fill"></i>
                  <span class="menu-title">About</span>
                </a>
            </li>
        </ul>
      </nav>
    </div>
  </header>

<aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">Board</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content"><p>ğŸ’•ğŸ˜ğŸ±â€ğŸ‘¤ğŸ±â€ğŸâœ¨</p>
            </div>
        </div>
    </div>
</div>

      <div class="widget">
    <h3 class="widget-title"> Tags</h3>
    <div id="tag-cloud-list" class="widget-body">
            
            
            <a href="https://wymli.github.io/tags/ai-agent/" class="tag-list-link" rel="1">ai agent<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/airflow/" class="tag-list-link" rel="1">airflow<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/algorithm/" class="tag-list-link" rel="1">algorithm<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/arch/" class="tag-list-link" rel="1">arch<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/argo/" class="tag-list-link" rel="1">argo<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/atomic/" class="tag-list-link" rel="1">atomic<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/bigdata/" class="tag-list-link" rel="3">bigdata<span
               class="tag-list-count">3</span></a>
            
            
            <a href="https://wymli.github.io/tags/bytedance/" class="tag-list-link" rel="1">bytedance<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/c/" class="tag-list-link" rel="2">c<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/cache/" class="tag-list-link" rel="1">cache<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/cli/" class="tag-list-link" rel="2">cli<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/concurrency/" class="tag-list-link" rel="1">concurrency<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/container/" class="tag-list-link" rel="6">container<span
               class="tag-list-count">6</span></a>
            
            
            <a href="https://wymli.github.io/tags/containerd/" class="tag-list-link" rel="1">containerd<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/database/" class="tag-list-link" rel="4">database<span
               class="tag-list-count">4</span></a>
            
            
            <a href="https://wymli.github.io/tags/datamining/" class="tag-list-link" rel="1">datamining<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/datastructure/" class="tag-list-link" rel="1">datastructure<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/db/" class="tag-list-link" rel="1">db<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/deploy/" class="tag-list-link" rel="1">deploy<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/designpattern/" class="tag-list-link" rel="1">designpattern<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/distribute/" class="tag-list-link" rel="1">distribute<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/eino/" class="tag-list-link" rel="1">eino<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/epoll/" class="tag-list-link" rel="1">epoll<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/event-stream/" class="tag-list-link" rel="1">event-stream<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/golang/" class="tag-list-link" rel="20">golang<span
               class="tag-list-count">20</span></a>
            
            
            <a href="https://wymli.github.io/tags/gpu/" class="tag-list-link" rel="2">gpu<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/http/" class="tag-list-link" rel="2">http<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/interview/" class="tag-list-link" rel="3">interview<span
               class="tag-list-count">3</span></a>
            
            
            <a href="https://wymli.github.io/tags/js/" class="tag-list-link" rel="1">js<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/k8s/" class="tag-list-link" rel="5">k8s<span
               class="tag-list-count">5</span></a>
            
            
            <a href="https://wymli.github.io/tags/kafka/" class="tag-list-link" rel="5">kafka<span
               class="tag-list-count">5</span></a>
            
            
            <a href="https://wymli.github.io/tags/llm/" class="tag-list-link" rel="1">llm<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/lsh/" class="tag-list-link" rel="1">lsh<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/net/" class="tag-list-link" rel="1">net<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/oauth2/" class="tag-list-link" rel="1">oauth2<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/oci/" class="tag-list-link" rel="5">oci<span
               class="tag-list-count">5</span></a>
            
            
            <a href="https://wymli.github.io/tags/other/" class="tag-list-link" rel="2">other<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/overlayfs/" class="tag-list-link" rel="1">overlayfs<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/proc/" class="tag-list-link" rel="1">proc<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/python/" class="tag-list-link" rel="1">python<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/redis/" class="tag-list-link" rel="2">redis<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/rpc/" class="tag-list-link" rel="4">rpc<span
               class="tag-list-count">4</span></a>
            
            
            <a href="https://wymli.github.io/tags/runc/" class="tag-list-link" rel="2">runc<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/schedule/" class="tag-list-link" rel="1">schedule<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/scheduler/" class="tag-list-link" rel="1">scheduler<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/script/" class="tag-list-link" rel="1">script<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/server/" class="tag-list-link" rel="3">server<span
               class="tag-list-count">3</span></a>
            
            
            <a href="https://wymli.github.io/tags/socket/" class="tag-list-link" rel="1">socket<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/sys/" class="tag-list-link" rel="2">sys<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/taskqueue/" class="tag-list-link" rel="1">taskqueue<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/temporal/" class="tag-list-link" rel="1">temporal<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/tensorflow/" class="tag-list-link" rel="1">tensorflow<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/todo/" class="tag-list-link" rel="1">todo<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/underthehood/" class="tag-list-link" rel="1">underthehood<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/ut/" class="tag-list-link" rel="1">ut<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/uv/" class="tag-list-link" rel="1">uv<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/volcano/" class="tag-list-link" rel="2">volcano<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/vue/" class="tag-list-link" rel="2">vue<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/workflow/" class="tag-list-link" rel="2">workflow<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://wymli.github.io/tags/wsl/" class="tag-list-link" rel="1">wsl<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://wymli.github.io/tags/zookeeper/" class="tag-list-link" rel="1">zookeeper<span
               class="tag-list-count">1</span></a>
            
    </div>
<script>
document.onreadystatechange = () => {
  if (document.readyState === 'complete') {
    tagCloud('#tag-cloud-list a',  8 ,  20 );
  }
};

function tagCloud(where, min, max) {
  let iMax = 0;
  let iMin = 0;
  $(where).each(function() {
    let weight = Number($(this).attr("rel"));
    if(iMax < weight) iMax = weight;
    if(iMin > weight || iMin == 0) iMin = weight;
  });
  let step = (max - min)/(iMax - iMin);
  $(where).each(function() {
    let weight = $(this).attr("rel") - iMin;
    $(this).css({"font-size": min + (weight * step) + 'px'});
  });
};
</script>
</div>

      <div class="widget">
    <h3 class="widget-title"> Categories</h3>
    <div class="widget-body">
        <ul class="category-list">
            <li class="category-list-item"><a href="https://wymli.github.io/categories/ai-agent/" class="category-list-link">ai agent</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/algorithm/" class="category-list-link">algorithm</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/arch/" class="category-list-link">arch</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/argo/" class="category-list-link">argo</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/atomic/" class="category-list-link">atomic</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/bigdata/" class="category-list-link">bigdata</a><span class="category-list-count">3</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/bytedance/" class="category-list-link">bytedance</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/c/" class="category-list-link">c</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/cache/" class="category-list-link">cache</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/cli/" class="category-list-link">cli</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/concurrency/" class="category-list-link">concurrency</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/configcenter/" class="category-list-link">configcenter</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/container/" class="category-list-link">container</a><span class="category-list-count">6</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/database/" class="category-list-link">database</a><span class="category-list-count">4</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/datamining/" class="category-list-link">datamining</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/datastructure/" class="category-list-link">datastructure</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/db/" class="category-list-link">db</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/deploy/" class="category-list-link">deploy</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/distribute/" class="category-list-link">distribute</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/golang/" class="category-list-link">golang</a><span class="category-list-count">20</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/gpu/" class="category-list-link">gpu</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/http/" class="category-list-link">http</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/install/" class="category-list-link">install</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/interview/" class="category-list-link">interview</a><span class="category-list-count">3</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/js/" class="category-list-link">js</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/k8s/" class="category-list-link">k8s</a><span class="category-list-count">5</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/linux/" class="category-list-link">linux</a><span class="category-list-count">3</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/llm/" class="category-list-link">llm</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/messagequeue/" class="category-list-link">messagequeue</a><span class="category-list-count">5</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/net/" class="category-list-link">net</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/os/" class="category-list-link">os</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/os-memory/" class="category-list-link">os-memory</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/other/" class="category-list-link">other</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/protocal/" class="category-list-link">protocal</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/protocol/" class="category-list-link">protocol</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/python/" class="category-list-link">python</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/redis/" class="category-list-link">redis</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/rpc/" class="category-list-link">rpc</a><span class="category-list-count">4</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/script/" class="category-list-link">script</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/sys/" class="category-list-link">sys</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/taskqueue/" class="category-list-link">taskqueue</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/tensorflow/" class="category-list-link">tensorflow</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/todo/" class="category-list-link">todo</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/underthehood/" class="category-list-link">underthehood</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/volcano/" class="category-list-link">volcano</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/vue/" class="category-list-link">vue</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://wymli.github.io/categories/workflow/" class="category-list-link">workflow</a><span class="category-list-count">2</span></li>
        </ul>
    </div>
</div>
      <div class="widget">
    <h3 class="widget-title"> Tags</h3>
    <div class="widget-body">
        <ul class="tag-list">
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/ai-agent/" class="tag-list-link">ai agent</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/airflow/" class="tag-list-link">airflow</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/algorithm/" class="tag-list-link">algorithm</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/arch/" class="tag-list-link">arch</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/argo/" class="tag-list-link">argo</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/atomic/" class="tag-list-link">atomic</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/bigdata/" class="tag-list-link">bigdata</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/bytedance/" class="tag-list-link">bytedance</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/c/" class="tag-list-link">c</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/cache/" class="tag-list-link">cache</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/cli/" class="tag-list-link">cli</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/concurrency/" class="tag-list-link">concurrency</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/container/" class="tag-list-link">container</a><span
                    class="tag-list-count">6</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/containerd/" class="tag-list-link">containerd</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/database/" class="tag-list-link">database</a><span
                    class="tag-list-count">4</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/datamining/" class="tag-list-link">datamining</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/datastructure/" class="tag-list-link">datastructure</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/db/" class="tag-list-link">db</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/deploy/" class="tag-list-link">deploy</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/designpattern/" class="tag-list-link">designpattern</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/distribute/" class="tag-list-link">distribute</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/eino/" class="tag-list-link">eino</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/epoll/" class="tag-list-link">epoll</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/event-stream/" class="tag-list-link">event-stream</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/golang/" class="tag-list-link">golang</a><span
                    class="tag-list-count">20</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/gpu/" class="tag-list-link">gpu</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/http/" class="tag-list-link">http</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/interview/" class="tag-list-link">interview</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/js/" class="tag-list-link">js</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/k8s/" class="tag-list-link">k8s</a><span
                    class="tag-list-count">5</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/kafka/" class="tag-list-link">kafka</a><span
                    class="tag-list-count">5</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/llm/" class="tag-list-link">llm</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/lsh/" class="tag-list-link">lsh</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/net/" class="tag-list-link">net</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/oauth2/" class="tag-list-link">oauth2</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/oci/" class="tag-list-link">oci</a><span
                    class="tag-list-count">5</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/other/" class="tag-list-link">other</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/overlayfs/" class="tag-list-link">overlayfs</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/proc/" class="tag-list-link">proc</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/python/" class="tag-list-link">python</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/redis/" class="tag-list-link">redis</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/rpc/" class="tag-list-link">rpc</a><span
                    class="tag-list-count">4</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/runc/" class="tag-list-link">runc</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/schedule/" class="tag-list-link">schedule</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/scheduler/" class="tag-list-link">scheduler</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/script/" class="tag-list-link">script</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/server/" class="tag-list-link">server</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/socket/" class="tag-list-link">socket</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/sys/" class="tag-list-link">sys</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/taskqueue/" class="tag-list-link">taskqueue</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/temporal/" class="tag-list-link">temporal</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/tensorflow/" class="tag-list-link">tensorflow</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/todo/" class="tag-list-link">todo</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/underthehood/" class="tag-list-link">underthehood</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/ut/" class="tag-list-link">ut</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/uv/" class="tag-list-link">uv</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/volcano/" class="tag-list-link">volcano</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/vue/" class="tag-list-link">vue</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/workflow/" class="tag-list-link">workflow</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/wsl/" class="tag-list-link">wsl</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://wymli.github.io/tags/zookeeper/" class="tag-list-link">zookeeper</a><span
                    class="tag-list-count">1</span></li>
            
        </ul>

    </div>
</div>
      
<div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
        <ul class="recent-post-list list-unstyled no-thumbnail">
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://wymli.github.io/2021/04/a1underthehood-underthehood/" class="title">[UnderTheHood] åŸºç¡€-é‡è¦-çŸ¥è¯†-æ•™æ—¨-æ ¼è¨€-è‰</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2021-04-10 00:00:00 &#43;0000 UTC" itemprop="datePublished">2021-04-10</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://wymli.github.io/2025/06/learning-redis-datastructure/" class="title">Learning: Redis DataStructure</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2025-06-12 00:00:00 &#43;0000 UTC" itemprop="datePublished">2025-06-12</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://wymli.github.io/2025/06/gpu-learning-gpu-patitioning-and-nvidia-gpu-operator/" class="title">Learning: GPU Patitioning and NVIDIA GPU Operator</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2025-06-09 00:00:00 &#43;0000 UTC" itemprop="datePublished">2025-06-09</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://wymli.github.io/2025/06/argo-learning-argo/" class="title">[argo] Learning: Argo</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2025-06-07 00:00:00 &#43;0000 UTC" itemprop="datePublished">2025-06-07</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://wymli.github.io/2025/05/js-javascript-is-all-you-need/" class="title">JS: Javascript is all you need</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2025-05-30 00:00:00 &#43;0000 UTC" itemprop="datePublished">2025-05-30</time>
                    </p>
                </div>
            </li>
        </ul>
    </div>
</div>
  </div>
</aside>

    
    
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <h4 class="toc-title">Catalogue</h4>
    <nav id="toc" class="js-toc toc">

    </nav>
  </div>
</aside>
<main class="main" role="main"><div class="content">
  <article id="-" class="article article-type-" itemscope
    itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      <h1 itemprop="name">
  <a
    class="article-title"
    href="/2025/03/container-6.%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80%E4%B9%8Brunc%E6%BA%90%E7%A0%81/"
    >[container] 6.å®¹å™¨åŸºç¡€ä¹‹runcæºç </a
  >
</h1>

      <div class="article-meta">
        
<span class="article-date">
  <i class="icon icon-calendar-check"></i>&nbsp;
<a href="https://wymli.github.io/2025/03/container-6.%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80%E4%B9%8Brunc%E6%BA%90%E7%A0%81/" class="article-date">
  <time datetime="2025-03-14 00:00:00 &#43;0000 UTC" itemprop="datePublished">2025-03-14</time>
</a>
</span>
<span class="article-category">
  <i class="icon icon-folder"></i>&nbsp;
  <a class="article-category-link" href="/categories/container/"> container </a>
</span>  
  <span class="article-tag">
    <i class="icon icon-tags"></i>&nbsp;
    <a class="article-tag-link" href="/tags/container/"> container </a>
    <a class="article-tag-link" href="/tags/oci/"> oci </a>
    <a class="article-tag-link" href="/tags/runc/"> runc </a>
  </span>

		<span class="post-wordcount hidden-xs" itemprop="wordCount">Word Count: 8564 words</span>
		<span class="post-readcount hidden-xs" itemprop="timeRequired">Read Time: 18 minutes </span>
      </div>
    </div>
    <div class="article-entry marked-body js-toc-content" itemprop="articleBody">
      <p>git clone <a href="https://github.com/opencontainers/runc.git">https://github.com/opencontainers/runc.git</a>, æˆ‘ä»¬ç®€å•é˜…è¯»ä¸‹ï¼Œä»£ç ä¸å¤š</p>
<h1 id="å…¥å£">å…¥å£</h1>
<p>å…¥å£æ²¡å•¥å¥½è¯´çš„ï¼Œå…ˆæ‰¾main.goæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°runcè¿™ä¸ªåº“ç”¨äº† github.com/urfave/cli è¿™ä¸ªå‘½ä»¤è¡Œåº“å’Œ github.com/sirupsen/logrus è¿™ä¸ªæ—¥å¿—åº“ï¼Œèƒ½åœ¨è¿™ç§æ¯”è¾ƒé‡è¦çš„å·¥å…·é‡Œé¢ä½¿ç”¨ï¼Œè¯´æ˜è¿™ä¸¤ä¸ªåº“æ˜¯å¾ˆä¸é”™çš„ã€‚</p>
<h1 id="create">create</h1>
<p>createçš„å®é™…ä½œç”¨æ˜¯ç”±runcæ‹‰èµ·ä¸€ä¸ª runcï¼ˆé€šå¸¸ç§°ä¸ºparentProcessï¼Œä¹Ÿå°±æ˜¯ runc create &hellip; è¿™ä¸ªè¿›ç¨‹ï¼‰ æ‹‰èµ·ä¸€ä¸ªå­runcè¿›ç¨‹ï¼ˆé€šå¸¸ç§°ä¸ºchildProcess, æˆ–æ›´ç²¾ç¡®çš„ï¼ŒinitProcessï¼‰ï¼Œå­runcè¿›ç¨‹çš„æ‰§è¡Œå‘½ä»¤ä¸º <code>runc init</code>, æ‰§è¡Œåä¼šè¿›è¡Œæ‰€æœ‰ns/rootfsçš„åˆå§‹åŒ–æ“ä½œï¼Œå¹¶é˜»å¡åœ¨æ‰“å¼€exec.fifoå‘½åç®¡é“ä¸Šï¼Œç­‰å¾…startæŒ‡ä»¤ï¼Œæ”¶åˆ°æŒ‡ä»¤ä¹‹åä¼šç«‹å³æ‰§è¡Œsystem.ExecåŸåœ°å°†è‡ªå·±æ›¿æ¢æˆç”¨æˆ·ä¸»è¿›ç¨‹ã€‚<br>
è¿™é‡Œæœ‰æ— startå…¶å®éƒ½ä¸å¤ªé‡è¦ï¼Œcreateä¹‹åå®¹å™¨ç¯å¢ƒå°±åˆ›å»ºå¥½äº†ï¼Œåç»­æ— è®ºæ˜¯startè¿˜æ˜¯execéƒ½è¡Œï¼Œä¸€ä¸ªæ˜¯æ‰§è¡Œconfig.jsoné‡Œçš„ä¸»è¿›ç¨‹ï¼Œä¸€ä¸ªæ˜¯æ‰§è¡Œexecå‘½ä»¤è¡Œé‡Œçš„è¿›ç¨‹ã€‚</p>
<h2 id="notifysock-åˆ›å»º">notify.sock åˆ›å»º</h2>
<p>å¦‚æœæŒ‡å®šäº†ç¯å¢ƒå˜é‡ NOTIFY_SOCKETï¼Œ ä¼šåˆ›å»ºnotify.sock<br>
é»˜è®¤åˆ›å»ºåœ¨ ${root}/${container_name}/notify/notify.sock, rootæ˜¯/run/runc æˆ–è€… /run/user/1000/runc</p>
<pre><code>notifySocket := newNotifySocket(context, os.Getenv(&quot;NOTIFY_SOCKET&quot;), id)
if notifySocket != nil {
    notifySocket.setupSpec(spec) // åœ¨ config.json ä¸­æ·»åŠ  notify.socket çš„mountå’Œenv
}

// ...
// åˆ›å»ºå®¹å™¨ ...
// ...

if notifySocket != nil {
    if err := notifySocket.setupSocketDirectory(); err != nil { // åˆ›å»ºç›®å½•å’Œæƒé™ os.Mkdir(path.Dir(s.socketPath), 0o755)
        return -1, err
    }
    if action == CT_ACT_RUN { // å¦‚æœæ˜¯åœ¨è¿è¡Œå®¹å™¨ï¼Œå°±ç”Ÿæˆsocketæ–‡ä»¶
        if err := notifySocket.bindSocket(); err != nil {
            return -1, err
        }
    }
}
</code></pre>
<p>notifySocket çš„ä¸»è¦é€»è¾‘å…¶å®å°±æ˜¯ç›‘å¬ notify.socket, è½¬å‘åˆ°ç”¨æˆ·è‡ªå®šä¹‰çš„ socket addr, åº”è¯¥æ˜¯ç”¨æ¥å®ç°ä¸€äº›äº‹ä»¶é©±åŠ¨çš„</p>
<pre><code>func (n *notifySocket) run(pid1 int) error {
	if n.socket == nil {
		return nil
	}
	notifySocketHostAddr := net.UnixAddr{Name: n.host, Net: &quot;unixgram&quot;}
	client, err := net.DialUnix(&quot;unixgram&quot;, nil, &amp;notifySocketHostAddr)
	if err != nil {
		return err
	}

	ticker := time.NewTicker(time.Millisecond * 100)
	defer ticker.Stop()

	fileChan := make(chan []byte)
	go func() {
		for {
			buf := make([]byte, 4096)
			r, err := n.socket.Read(buf)
			if err != nil {
				return
			}
			got := buf[0:r]
			// systemd-ready sends a single datagram with the state string as payload,
			// so we don't need to worry about partial messages.
			for _, line := range bytes.Split(got, []byte{'\n'}) {
				if bytes.HasPrefix(got, []byte(&quot;READY=&quot;)) {
					fileChan &lt;- line
					return
				}
			}

		}
	}()

	for {
		select {
		case &lt;-ticker.C:
			_, err := os.Stat(filepath.Join(&quot;/proc&quot;, strconv.Itoa(pid1)))
			if err != nil {
				return nil
			}
		case b := &lt;-fileChan:
			return notifyHost(client, b, pid1)
		}
	}
}
</code></pre>
<h2 id="systemd-on-demand-socket">systemd on-demand socket</h2>
<p>è¿™é‡Œå­¦åˆ°ä¸€ä¸ªæ–°çŸ¥è¯†ï¼Œsystemd on-demand socketï¼Œå¤§è‡´æ„æ€æ—¶ï¼Œé…ç½®ä¸€ä¸ªsystemdçš„socketæ–‡ä»¶ï¼Œç›‘å¬æŸä¸ªç«¯å£ï¼Œå†é…ç½®ä¸€ä¸ªsystemdçš„serviceæ–‡ä»¶ï¼Œå…³è”æŸä¸ªsocketæ–‡ä»¶ï¼Œéšåï¼Œå½“è¯·æ±‚æ‰“åˆ°socketæ–‡ä»¶å…³è”çš„ç«¯å£æ—¶ï¼Œä¼šå¯åŠ¨serviceæ–‡ä»¶ï¼Œåšåˆ°æŒ‰éœ€å¯åŠ¨çš„åŠŸèƒ½ã€‚</p>
<pre><code>// Support on-demand socket activation by passing file descriptors into the container init process.
listenFDs := []*os.File{}
if os.Getenv(&quot;LISTEN_FDS&quot;) != &quot;&quot; {
    listenFDs = activation.Files(false)
}

// ...
if len(r.listenFDs) &gt; 0 {
    process.Env = append(process.Env, &quot;LISTEN_FDS=&quot;+strconv.Itoa(len(r.listenFDs)), &quot;LISTEN_PID=1&quot;)
    process.ExtraFiles = append(process.ExtraFiles, r.listenFDs...) // åº”è¯¥æ˜¯ä¸ºäº†å®¹å™¨å†…çš„è¿›ç¨‹å¯ä»¥è¯»åˆ°LISTEN_FD
}
</code></pre>
<p>å›å¤´ä¸“é—¨å¼€ä¸€ç« è·‘ä¸ªdemoè¯•è¯•ï¼Œæœ‰ç‚¹faasçš„æ„æ€</p>
<h2 id="create-container">create container</h2>
<pre><code>func createContainer(context *cli.Context, id string, spec *specs.Spec) (*libcontainer.Container, error) {
	rootlessCg, err := shouldUseRootlessCgroupManager(context) // å†…å®¹æš‚æ—¶çœ‹ä¸æ‡‚ï¼Œåæ­£å°±æ˜¯å‡†å¤‡rootless cgroupé…ç½®
	if err != nil {
		return nil, err
	}
	config, err := specconv.CreateLibcontainerConfig(&amp;specconv.CreateOpts{ // è¿™ä¸€æ­¥æ˜¯å°†runc çš„configè½¬æˆ libcontainerçš„config
		CgroupName:       id,
		UseSystemdCgroup: context.GlobalBool(&quot;systemd-cgroup&quot;),
		NoPivotRoot:      context.Bool(&quot;no-pivot&quot;),
		NoNewKeyring:     context.Bool(&quot;no-new-keyring&quot;),
		Spec:             spec,
		RootlessEUID:     os.Geteuid() != 0,
		RootlessCgroups:  rootlessCg,
	})
	if err != nil {
		return nil, err
	}

	root := context.GlobalString(&quot;root&quot;)
	return libcontainer.Create(root, id, config) // å¾—åˆ°äº†ä¸€ä¸ª Container ç»“æ„ä½“
}
</code></pre>
<h2 id="å¤„ç†container-console-io">å¤„ç†container console io</h2>
<p>æˆ‘ä»¬çŸ¥é“dockerä¸€èˆ¬æœ‰ <code>-i</code>, <code>-t</code>, <code>-d</code> é€‰é¡¹å’Œconsole ioæœ‰å…³</p>
<ul>
<li>-i äº¤äº’æ¨¡å¼ï¼šå®¹å™¨å…±äº«çˆ¶è¿›ç¨‹çš„stdin/stdout/stderr</li>
<li>-t æ‰“å¼€ä¸€ä¸ªä¼ªç»ˆç«¯: ä¼ªç»ˆç«¯çš„æ„ä¹‰å°±æ˜¯å°†stdin/stdoutå˜å¾—ä¸å†æ˜¯ä¸€ä¸ªè¾“å…¥è¾“å‡ºæµï¼Œè€Œæ˜¯åƒä¸€ä¸ªçœŸçš„ç»ˆç«¯ä¸€ç‚¹ï¼Œæ”¯æŒæ§åˆ¶å­—ç¬¦ä¹‹ç±»çš„ï¼Œæ¯”å¦‚é€€æ ¼é”®å’Œæ–¹å‘é”®ï¼Œæ¯”å¦‚æ˜¾ç¤ºé¢œè‰²</li>
<li>-d detachï¼šå®¹å™¨åœ¨åå°è¿è¡Œï¼Œä¸å ç”¨å½“å‰ç»ˆç«¯</li>
</ul>
<pre><code>
// setupIO modifies the given process config according to the options.
func setupIO(process *libcontainer.Process, container *libcontainer.Container, createTTY, detach bool, sockpath string) (*tty, error) {
    // -t å¯¹åº” createTTY
	if createTTY {
		process.Stdin = nil // æ¸…ç©ºè¿›ç¨‹çš„æ ‡å‡†è¾“å…¥è¾“å‡º
		process.Stdout = nil
		process.Stderr = nil
		t := &amp;tty{}
		if !detach {
			if err := t.initHostConsole(); err != nil { // ä» stderr, stdout, stdin ä¸­æ‰¾åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„console(tty)ï¼Œå› ä¸ºæœ‰å¯èƒ½å½“å‰è¿›ç¨‹å¹¶æ²¡æœ‰attachä¸€ä¸ªconsole
				return nil, err
			}
			parent, child, err := utils.NewSockPair(&quot;console&quot;)
			if err != nil {
				return nil, err
			}
			process.ConsoleSocket = child
			t.postStart = append(t.postStart, parent, child) // io.closer
			t.consoleC = make(chan error, 1) // è¿™ä¸ªå°±æ˜¯ä¸€ä¸ªç®€å•çš„waitä¿¡å·äº†ï¼Œconsole channel
			go func() {
				t.consoleC &lt;- t.recvtty(parent)
			}()
		} else {
			// the caller of runc will handle receiving the console master
			conn, err := net.Dial(&quot;unix&quot;, sockpath)
			if err != nil {
				return nil, err
			}
			uc, ok := conn.(*net.UnixConn)
			if !ok {
				return nil, errors.New(&quot;casting to UnixConn failed&quot;)
			}
			t.postStart = append(t.postStart, uc)
			socket, err := uc.File()
			if err != nil {
				return nil, err
			}
			t.postStart = append(t.postStart, socket)
			process.ConsoleSocket = socket // å¦‚æœæŒ‡å®šäº†detachï¼Œåˆæƒ³åˆ†é…ttyï¼Œå°±å¾—æŒ‡å®šä¸€ä¸ªsocket path
		}
		return t, nil
	}
	// when runc will detach the caller provides the stdio to runc via runc's 0,1,2
	// and the container's process inherits runc's stdio.
	if detach {
        // ç›´æ¥ç»§æ‰¿runcè¿›ç¨‹çš„stdioï¼Œå¯ä»¥å’Œ setupProcessPipes å¯¹æ¯”ï¼Œ setupProcessPipesæ˜¯æ–°å»ºpipeï¼Œåœ¨runcè¿›ç¨‹çš„stdioä¹‹é—´æ‹·è´
        // ç›´æ¥ç»§æ‰¿çš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ
		inheritStdio(process) // ä½¿ç”¨runcè¿›ç¨‹çš„stdio, ä¹Ÿå°±æ˜¯os.stdout, os.stdin, os.stderr
		return &amp;tty{}, nil
	}

	config := container.Config()
	rootuid, err := config.HostRootUID() // rootlessç›¸å…³é…ç½®
	if err != nil {
		return nil, err
	}
	rootgid, err := config.HostRootGID() // rootlessç›¸å…³é…ç½®
	if err != nil {
		return nil, err
	}

    // å¦‚æœæ—¢æ²¡æœ‰ttyï¼Œä¹Ÿæ²¡æœ‰detachï¼Œè¿›å…¥è¿™é‡Œ
	return setupProcessPipes(process, rootuid, rootgid)
}


// setup pipes for the process so that advanced features like c/r are able to easily checkpoint
// and restore the process's IO without depending on a host specific path or device
func setupProcessPipes(p *libcontainer.Process, rootuid, rootgid int) (*tty, error) {
	i, err := p.InitializeIO(rootuid, rootgid) åˆ›å»º os.Pipe, wç«¯æŒ‚åœ¨processä¸Šï¼Œrç«¯æŒ‚åœ¨iï¼Œiå°†ä¼šè¢«ä¸‹é¢çš„ä»£ç ä½¿ç”¨
    // è¿™é‡Œè¦æ–°åˆ›å»ºä¸€ä¸ªos.Pipeï¼Œè€Œä¸æ˜¯ç›´æ¥ç»§æ‰¿runcè¿›ç¨‹çš„stdioçš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿå¯èƒ½æ˜¯æ€•å¤šè¿›ç¨‹å†™åŒä¸€ä¸ªpipeå†™åäº†?
	if err != nil {
		return nil, err
	}
	t := &amp;tty{
		closers: []io.Closer{
			i.Stdin,
			i.Stdout,
			i.Stderr,
		},
	}
	// add the process's io to the post start closers if they support close
	for _, cc := range []interface{}{
		p.Stdin,
		p.Stdout,
		p.Stderr,
	} {
		if c, ok := cc.(io.Closer); ok {
			t.postStart = append(t.postStart, c)
		}
	}
	go func() {
		_, _ = io.Copy(i.Stdin, os.Stdin) // ä¸€ç›´copyç›´åˆ° stdin EOF
		_ = i.Stdin.Close() // stdin ä¸ç”¨ t.copyIO æ˜¯å› ä¸ºcopyå®Œåè¦å…³é—­wç«¯
	}()
	t.wg.Add(2)
	go t.copyIO(os.Stdout, i.Stdout) // copyå®Œåå…³é—­è¯»ç«¯, ä¸€ç›´copyç›´åˆ°EOF
	go t.copyIO(os.Stderr, i.Stderr)
	return t, nil
}


</code></pre>
<h2 id="init-process">init process</h2>
<p>åœ¨startçš„æ ¸å¿ƒé€»è¾‘ <code>container.start(process)</code> ä¸­ï¼Œé€šè¿‡ <code>parent, err := c.newParentProcess(process)</code> åˆ›å»ºå‡ºparentProcess, è¿™é‡Œçš„ parentProcess æœ‰ä¸¤ç§ï¼ŒinitProcess æˆ– setnsProcessï¼ˆè¿™é‡Œå…¶å®å«åš ProcessControler å¥½ä¸€ç‚¹ï¼Œä¼šç”±è¿™ä¸ªcontrolerå¯åŠ¨å­è¿›ç¨‹ï¼Œå¹¶å’Œå­è¿›ç¨‹äº¤äº’ï¼‰<br>
ç®€åŒ–åå¦‚ä¸‹:</p>
<pre><code>cmd := exec.Command(&quot;/proc/self/exe&quot;, &quot;init&quot;) // `runc init`
cmd.Args[0] = os.Args[0]
cmd.Stdin = p.Stdin
cmd.Stdout = p.Stdout
cmd.Stderr = p.Stderr
cmd.Dir = c.config.Rootfs

// ...

// åˆ›å»º ipc socket pair (è¿™é‡Œä¸åˆ›å»ºos.Pipe, è€Œæ˜¯uds, å› ä¸ºudsæ˜¯åŒå‘çš„ï¼Œæ›´çµæ´»ï¼Œç®¡é“æ˜¯å•å‘çš„)
var (
	comm processComm
	err  error
)
comm.initSockParent, comm.initSockChild, err = utils.NewSockPair(&quot;init&quot;) // initSock(æˆ–è€…æ˜¯initPipe, ä»£ç é‡Œé¢æ˜¯æ··ç”¨çš„) ä½œç”¨æ˜¯ parentProcesså’ŒchildProcessè¿›è¡Œäº¤äº’ï¼Œä¼ é€’childProcessçš„real pid å’Œ ç”¨æˆ·è‡ªå®šä¹‰å‘½ä»¤ç­‰
if err != nil {
	return nil, fmt.Errorf(&quot;unable to create init pipe: %w&quot;, err)
}
comm.syncSockParent, comm.syncSockChild, err = newSyncSockpair(&quot;sync&quot;)
if err != nil {
	return nil, fmt.Errorf(&quot;unable to create sync pipe: %w&quot;, err)
}
comm.logPipeParent, comm.logPipeChild, err = os.Pipe()
if err != nil {
	return nil, fmt.Errorf(&quot;unable to create log pipe: %w&quot;, err)
}
return &amp;comm, nil

// ...

if p.Init {
	// We only set up fifoFd if we're not doing a `runc exec`. The historic
	// reason for this is that previously we would pass a dirfd that allowed
	// for container rootfs escape (and not doing it in `runc exec` avoided
	// that problem), but we no longer do that. However, there's no need to do
	// this for `runc exec` so we just keep it this way to be safe.
	if err := c.includeExecFifo(cmd); err != nil {
		return nil, fmt.Errorf(&quot;unable to setup exec fifo: %w&quot;, err)
	}
	
	return c.newInitProcess(p, cmd, comm)
	//	init := &amp;initProcess{
	//		containerProcess: containerProcess{
	//			cmd:           cmd, // runc init
	//			comm:          comm, // å‡ ä¸ªé€šä¿¡çš„uds
	//			manager:       c.cgroupManager,
	//			config:        c.newInitConfig(p), // é‡Œé¢æ˜¯ childProcess ç”¨æˆ·è¿›ç¨‹çš„å‘½ä»¤ï¼Œå¦‚æœæ˜¯initProcessï¼Œè¿™é‡Œæ˜¯config.json é‡Œçš„command
	//			process:       p,
	//			bootstrapData: data,
	//			container:     c,
	//		},
	//		intelRdtManager: c.intelRdtManager,
	//	}
	//	c.initProcess = init
}
return c.newSetnsProcess(p, cmd, comm)
//	proc := &amp;setnsProcess{
//		containerProcess: containerProcess{
//			cmd:           cmd, // runc init
//			comm:          comm, // å‡ ä¸ªé€šä¿¡çš„uds
//			manager:       c.cgroupManager,
//			config:        c.newInitConfig(p),// é‡Œé¢æ˜¯process ç”¨æˆ·è¿›ç¨‹çš„å‘½ä»¤ï¼Œå¦‚æœæ˜¯setnsProcessï¼Œè¿™é‡Œæ˜¯ runc exec -it $container $command
//			process:       p,
//			bootstrapData: data,
//			container:     c,
//		},
//		cgroupPaths:     state.CgroupPaths,
//		rootlessCgroups: c.config.RootlessCgroups,
//		intelRdtPath:    state.IntelRdtPath,
//		initProcessPid:  state.InitProcessPid,
//	}
</code></pre>
<h2 id="container">Container</h2>
<p>æˆ‘ä»¬çœ‹çœ‹<code>container</code>æœ‰å“ªäº›æ“ä½œï¼š</p>
<pre><code>// å¯åŠ¨å®¹å™¨ï¼Œä¹Ÿå°±æ˜¯å¯åŠ¨ parentProcessï¼Œå¯èƒ½æ˜¯ initProcess ä¹Ÿå¯èƒ½æ˜¯ setnsProcess (å®ä¾‹åŒ–ä¸€ä¸ªprocessControleråæ‹‰èµ·childProcess)
func (c *Container) Start(process *Process) error {}


func (c *Container) Run(process *Process) error {}
func (c *Container) Exec() error {}

// è®¾ç½®å®¹å™¨çš„é…ç½®ï¼Œæ¯”å¦‚cgroupé…ç½®ï¼ˆå¯ä»¥ç”¨äºrunningæ€å®¹å™¨è°ƒæ•´èµ„æºï¼‰
func (c *Container) Set(config configs.Config) error {}

// runcè¿›ç¨‹åˆ›å»ºparentè¿›ç¨‹ï¼ˆparentè¿›ç¨‹åŒ…å«ä¸¤ç§:initProcess å’Œ setnsProcess ï¼‰
func (c *Container) newParentProcess(p *Process) (parentProcess, error) {}

// å®¹å™¨çš„initè¿›ç¨‹çš„controllerï¼Œå½“è°ƒç”¨runc createåè¢«è°ƒç”¨ï¼Œå®ä¾‹åŒ–çš„process controlerå°†æ‹‰èµ·å­è¿›ç¨‹å¯åŠ¨initè¿›ç¨‹ï¼ŒéšååŸåœ°execæˆç”¨æˆ·ä¸»è¿›ç¨‹
func (c *Container) newInitProcess(p *Process, cmd *exec.Cmd, comm *processComm) (*initProcess, error) {}

// å®¹å™¨çš„setnsè¿›ç¨‹çš„controllerï¼Œå½“è°ƒç”¨runc exec $command åè¢«è°ƒç”¨ï¼Œå®ä¾‹åŒ–çš„process controlerå°†æ‹‰èµ·å­è¿›ç¨‹å¯åŠ¨initè¿›ç¨‹ï¼ŒéšååŸåœ°execæˆ$commandè¿›ç¨‹
func (c *Container) newSetnsProcess(p *Process, cmd *exec.Cmd, comm *processComm) (*setnsProcess, error) {}

</code></pre>
<h2 id="parentprocess">parentProcess</h2>
<p>parentProcess æ˜¯ä¸ªinterfaceï¼Œ å¯èƒ½çš„å®ç°æ˜¯initProcessæˆ–è€…setnsProcess, è¿™é‡Œçš„parentProcess å¯ä»¥ç†è§£æˆä¸€ä¸ªprocess controllerï¼Œè´Ÿè´£æ‹‰èµ·å­è¿›ç¨‹å¹¶å’Œå­è¿›ç¨‹äº¤äº’ã€‚</p>
<pre><code>type parentProcess interface {
	// pid returns the pid for the running process.
	pid() int

	// start starts the process execution.
	start() error

	// send a SIGKILL to the process and wait for the exit.
	terminate() error

	// wait waits on the process returning the process state.
	wait() (*os.ProcessState, error)

	// startTime returns the process start time.
	startTime() (uint64, error)
	signal(os.Signal) error
	externalDescriptors() []string
	setExternalDescriptors(fds []string)
	forwardChildLogs() chan error
}
</code></pre>
<h3 id="initprocess-controller">initProcess Controller</h3>
<h4 id="parentprocess-1">parentProcess</h4>
<pre><code>// å¯åŠ¨ `runc init` è¿›ç¨‹
// err := p.cmd.Start() 
// ä¼ é€’ NewNetlinkRequest, è¿™é‡Œä½¿ç”¨NetLinkç»“æ„ï¼Œå› ä¸ºnetlinkç»“æ„æ˜¯å†…æ ¸æ”¯æŒçš„ï¼Œåé¢è°ƒç”¨ç³»ç»Ÿè°ƒç”¨æ—¶ä¼šæ¯”è¾ƒæ–¹ä¾¿
// if _, err := io.Copy(p.comm.initSockParent, p.bootstrapData); err != nil {
//    return fmt.Errorf(&quot;can't copy bootstrap data to pipe: %w&quot;, err)
// }
// é€šè¿‡initSockè·å–æœ€ç»ˆå­è¿›ç¨‹initProcessçš„pid ï¼ˆå­è¿›ç¨‹åœ¨cgoé‡Œé¢çš„nsexecå‡½æ•°é‡Œé¢ç»è¿‡äº†å¤šæ¬¡cloneï¼Œè¿™é‡Œæ‹¿åˆ°æœ€ç»ˆçš„å­è¿›ç¨‹ï¼‰
// childPid, err := p.getChildPid()
// ç­‰å¾…ç›´æ¥å­è¿›ç¨‹é€€å‡º, ç„¶åå°† initProcess è®¾ç½®ä¸ºå¾…ç®¡ç†çš„æœ€ç»ˆå­è¿›ç¨‹
// if err := p.waitForChildExit(childPid); err != nil {
//   return fmt.Errorf(&quot;error waiting for our first child to exit: %w&quot;, err)
// }
// å¯¹childPidåˆ›å»ºMounté…ç½®ï¼šè¿™é‡Œçš„requestæ˜¯ä¸ªå¾€requestChå‘é€æ•°æ®çš„fnï¼Œåœ¨ goCreateMountSources ä¸­åˆ›å»ºäº†requestChï¼Œå¹¶å¼‚æ­¥æ¶ˆè´¹requestChç”¨äºmount
// request, cancel, err := p.goCreateMountSources(context.Background())
// å¯¹childPidåˆ›å»ºç½‘ç»œé…ç½®
// p.createNetworkInterfaces()
// å‘initSock å‘é€ç”¨æˆ·è¿›ç¨‹ç›¸å…³çš„é…ç½®ï¼Œæ¯”å¦‚ç”¨æˆ·è¿›ç¨‹çš„å¯åŠ¨å‘½ä»¤
// utils.WriteJSON(p.comm.initSockParent, p.config)
// loop å¤„ç†å­è¿›ç¨‹å‘é€è¿‡æ¥çš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚ procMountPlease è¯·æ±‚æŒ‚è½½è·¯å¾„ï¼ŒprocSeccomp æš‚æ—¶æ²¡çœ‹æ‡‚æ˜¯åœ¨å¹²å˜›ï¼Œä¼¼ä¹åªæ˜¯å¾€ seccomp çš„listenerPathå‘é€äº†ç‚¹ä¸œè¥¿ï¼Œ  procReady ä»£è¡¨container createdæˆåŠŸï¼Œ procHooks ä»£è¡¨runcå¯ä»¥æ‰§è¡Œä¸€äº›hooksäº†ï¼Œæ¯”å¦‚Prestartã€CreateRuntime
// parseSync(p.comm.syncSockParent, func(sync *syncT) error {})
// è¯»åˆ°EOFæˆ–å¤„ç†erroråï¼Œå…³é—­socketå†™ç«¯ï¼Œè¯»ç«¯ä¼šæ”¶åˆ°EOF
// p.comm.syncSockParent.Shutdown(unix.SHUT_WR)
func (p *initProcess) start() (retErr error) {}
</code></pre>
<h4 id="childprocessç«¯">childProcessç«¯</h4>
<p>runcä¼šåˆ›å»ºå‡º <code>runc init</code> å­è¿›ç¨‹, è¿™ä¸ªè¿›ç¨‹ä¼šå…ˆè°ƒç”¨cgoé‡Œé¢çš„nsexecå‡½æ•°, cloneå‡ºå¤šä¸ªå­è¿›ç¨‹ï¼ˆcloneäº†ä¸¤æ¬¡ï¼Œç”¨äºsetnsç­‰ï¼‰ï¼Œæœ€ç»ˆå­è¿›ç¨‹ä¼šè°ƒç”¨ <code>return system.Exec(name, l.config.Args, l.config.Env)</code> åŸåœ°æ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰å‘½ä»¤ã€‚</p>
<pre><code>// å¯ä»¥çœ‹åˆ° `init` command æ²¡æœ‰æ³¨å†Œåœ¨main.go, è€Œæ˜¯æ³¨å†Œåœ¨ init func é‡Œ
// åŸå› å…¶å®æ¯”è¾ƒç®€å•ï¼Œæ˜¯å› ä¸ºä½¿ç”¨çš„cliåº“æ²¡æœ‰æä¾›ä¸€ç§ignoreå‚æ•°ï¼Œå¦‚æœcliåº“å…è®¸æ³¨å†ŒæŸç§commandï¼Œä½†æ˜¯ä¸å±•ç¤ºåœ¨helpä¿¡æ¯é‡Œï¼Œé‚£ä¹ˆä½œä¸ºå†…éƒ¨commandçš„initï¼Œä¹Ÿå¯ä»¥æ³¨å†Œåœ¨main.go é‡Œï¼Œè€Œä¸ç”¨hackåœ¨init func é‡Œã€‚
func init() {
	if len(os.Args) &gt; 1 &amp;&amp; os.Args[1] == &quot;init&quot; {
		// This is the golang entry point for runc init, executed
		// before main() but after libcontainer/nsenter's nsexec().
		libcontainer.Init()
	}
}

// libcontainer:
func Init() {
	runtime.GOMAXPROCS(1)
	runtime.LockOSThread()

	if err := startInitialization(); err != nil {
		// If the error is returned, it was not communicated
		// back to the parent (which is not a common case),
		// so print it to stderr here as a last resort.
		//
		// Do not use logrus as we are not sure if it has been
		// set up yet, but most important, if the parent is
		// alive (and its log forwarding is working).
		fmt.Fprintln(os.Stderr, err)
	}
	// Normally, StartInitialization() never returns, meaning
	// if we are here, it had failed.
	os.Exit(255) // å¯ä»¥çœ‹åˆ°è¿™é‡Œç›´æ¥é€€å‡ºäº†ï¼Œä¸ä¼šè¿›å…¥main å‡½æ•°
}

// Normally, this function does not return. If it returns, with or without an
// error, it means the initialization has failed. If the error is returned,
// it means the error can not be communicated back to the parent.
func startInitialization() (retErr error) {
	// Get the synchronisation pipe.
	envSyncPipe := os.Getenv(&quot;_LIBCONTAINER_SYNCPIPE&quot;)
	syncPipeFd, err := strconv.Atoi(envSyncPipe)
	if err != nil {
		return fmt.Errorf(&quot;unable to convert _LIBCONTAINER_SYNCPIPE: %w&quot;, err)
	}
	syncPipe := newSyncSocket(os.NewFile(uintptr(syncPipeFd), &quot;sync&quot;))
	defer syncPipe.Close()

	defer func() {
		// If this defer is ever called, this means initialization has failed.
		// Send the error back to the parent process in the form of an initError
		// if the sync socket has not been closed.
		if syncPipe.isClosed() {
			return
		}
		ierr := initError{Message: retErr.Error()}
		if err := writeSyncArg(syncPipe, procError, ierr); err != nil {
			fmt.Fprintln(os.Stderr, err)
			return
		}
		// The error is sent, no need to also return it (or it will be reported twice).
		retErr = nil
	}()

	// Get the INITPIPE.
	envInitPipe := os.Getenv(&quot;_LIBCONTAINER_INITPIPE&quot;)
	initPipeFd, err := strconv.Atoi(envInitPipe)
	if err != nil {
		return fmt.Errorf(&quot;unable to convert _LIBCONTAINER_INITPIPE: %w&quot;, err)
	}
	initPipe := os.NewFile(uintptr(initPipeFd), &quot;init&quot;)
	defer initPipe.Close()

	// Set up logging. This is used rarely, and mostly for init debugging.

	// Passing log level is optional; currently libcontainer/integration does not do it.
	if levelStr := os.Getenv(&quot;_LIBCONTAINER_LOGLEVEL&quot;); levelStr != &quot;&quot; {
		logLevel, err := strconv.Atoi(levelStr)
		if err != nil {
			return fmt.Errorf(&quot;unable to convert _LIBCONTAINER_LOGLEVEL: %w&quot;, err)
		}
		logrus.SetLevel(logrus.Level(logLevel))
	}

	logFd, err := strconv.Atoi(os.Getenv(&quot;_LIBCONTAINER_LOGPIPE&quot;))
	if err != nil {
		return fmt.Errorf(&quot;unable to convert _LIBCONTAINER_LOGPIPE: %w&quot;, err)
	}
	logPipe := os.NewFile(uintptr(logFd), &quot;logpipe&quot;)

	logrus.SetOutput(logPipe)
	logrus.SetFormatter(new(logrus.JSONFormatter))
	logrus.Debug(&quot;child process in init()&quot;)

	// Only init processes have FIFOFD.
	var fifoFile *os.File
	// è¿™é‡ŒinitType å°±ä¸¤ç§ç±»å‹ï¼šstandardã€setnsï¼Œstarndardè¡¨ç¤ºinitProcess
	envInitType := os.Getenv(&quot;_LIBCONTAINER_INITTYPE&quot;)
	it := initType(envInitType)
	if it == initStandard {
		// fifofd æ˜¯ exec.fifo æ–‡ä»¶ï¼Œæ˜¯ä¸ªfifoå‘½åç®¡é“ï¼Œç”¨äºé€šçŸ¥initProcess æ˜¯å¦å¯ä»¥è°ƒç”¨system.exec æ‰§è¡Œç”¨æˆ·ä¸»è¿›ç¨‹
		fifoFd, err := strconv.Atoi(os.Getenv(&quot;_LIBCONTAINER_FIFOFD&quot;))
		if err != nil {
			return fmt.Errorf(&quot;unable to convert _LIBCONTAINER_FIFOFD: %w&quot;, err)
		}
		fifoFile = os.NewFile(uintptr(fifoFd), &quot;initfifo&quot;)
	}

	var consoleSocket *os.File
	if envConsole := os.Getenv(&quot;_LIBCONTAINER_CONSOLE&quot;); envConsole != &quot;&quot; {
		console, err := strconv.Atoi(envConsole)
		if err != nil {
			return fmt.Errorf(&quot;unable to convert _LIBCONTAINER_CONSOLE: %w&quot;, err)
		}
		consoleSocket = os.NewFile(uintptr(console), &quot;console-socket&quot;)
		defer consoleSocket.Close()
	}

	var pidfdSocket *os.File
	if envSockFd := os.Getenv(&quot;_LIBCONTAINER_PIDFD_SOCK&quot;); envSockFd != &quot;&quot; {
		sockFd, err := strconv.Atoi(envSockFd)
		if err != nil {
			return fmt.Errorf(&quot;unable to convert _LIBCONTAINER_PIDFD_SOCK: %w&quot;, err)
		}
		pidfdSocket = os.NewFile(uintptr(sockFd), &quot;pidfd-socket&quot;)
		defer pidfdSocket.Close()
	}

	// From here on, we don't need current process environment. It is not
	// used directly anywhere below this point, but let's clear it anyway.
	os.Clearenv()

	defer func() {
		if err := recover(); err != nil {
			if err2, ok := err.(error); ok {
				retErr = fmt.Errorf(&quot;panic from initialization: %w, %s&quot;, err2, debug.Stack())
			} else {
				retErr = fmt.Errorf(&quot;panic from initialization: %v, %s&quot;, err, debug.Stack())
			}
		}
	}()

	// åœ¨è¿™é‡Œé˜»å¡è¯»runcè¿›ç¨‹å‘é€è¿‡æ¥çš„initæ•°æ®ï¼Œæ¯”å¦‚ç”¨æˆ·è¿›ç¨‹å‘½ä»¤å•¥çš„
	var config initConfig
	if err := json.NewDecoder(initPipe).Decode(&amp;config); err != nil {
		return err
	}

	// If init succeeds, it will not return, hence none of the defers will be called.
	return containerInit(it, &amp;config, syncPipe, consoleSocket, pidfdSocket, fifoFile, logPipe)
}
</code></pre>
<pre><code>i := &amp;linuxStandardInit{
	pipe:          pipe, // sync socket, ç”¨äºå’Œ parentProcess(ä¹Ÿå°±æ˜¯runc) äº¤äº’
	consoleSocket: consoleSocket, // console socket
	pidfdSocket:   pidfdSocket, // childProcess åˆ›å»ºå‡ºæ¥å, å‘é€childProcessçš„pidåˆ°socketï¼Œè¿™ä¸ªæ˜¯ç”¨æˆ·è‡ªå·±å»ºå‡ºæ¥çš„socketï¼Œä¸æ˜¯runcå†…éƒ¨çš„ã€‚åœ¨parentProcessä¸­openï¼Œç»§æ‰¿ç»™childProcess
	parentPid:     unix.Getppid(), // parentProcess(ä¹Ÿå°±æ˜¯runc)çš„pid
	config:        config, // ä»initPipe è¯»åˆ°çš„config, åŒ…å«ç”¨æˆ·è‡ªå®šä¹‰å‘½ä»¤ç­‰ä¿¡æ¯
	fifoFile:      fifoFile, // exec.fifo æ–‡ä»¶, initProcess ç‰¹æœ‰ï¼Œç”¨äºä½œä¸ºä¸€ç§ä¿¡å·é€šçŸ¥ï¼Œå‘ŠçŸ¥initProcesså¯ä»¥ä»createdå˜æˆrunning(å³è°ƒç”¨system.exec åŸåœ°æ›¿æ¢æˆç”¨æˆ·ä¸»è¿›ç¨‹)
	logPipe:       logPipe, // æ—¥å¿—pipeï¼Œæ—¥å¿—å°†è¢«parentProcessæ¶ˆè´¹
}
</code></pre>
<h2 id="fdç»§æ‰¿">fdç»§æ‰¿</h2>
<p>å¦‚æœé€šè¿‡<code>fork</code>, é‚£å½“ç„¶å°±ç›´æ¥ç»§æ‰¿äº†æ‰“å¼€çš„fdï¼Œå¦‚æœæ˜¯é€šè¿‡<code>*exec.Cmd</code>ï¼ˆæˆ–è€…å°±æ˜¯ä¸€èˆ¬è¯´çš„è°ƒç”¨å­è¿›ç¨‹çš„æ–¹å¼ï¼ˆæœ¬è´¨ä¸Šæ˜¯fork+execï¼‰ï¼‰, åœ¨goè¯­è¨€çš„å¤„ç†ä¸Šï¼Œæ˜¯é€šè¿‡<code>cmd.ExtraFiles</code>, æ¯”å¦‚ <code>cmd.ExtraFiles = append(cmd.ExtraFiles, fifo)</code></p>
<pre><code>ExtraFiles specifies additional open files to be inherited by the new process. It does not include standard input, standard output, or standard error. If non-nil, entry i becomes file descriptor 3+i.

ExtraFiles is not supported on Windows.

field ExtraFiles []*os.File
</code></pre>
<p>å­è¿›ç¨‹ä½¿ç”¨è¯¥æè¿°ç¬¦æ—¶ï¼Œå…¶fdç¼–å·ä»3å¼€å§‹ï¼ˆå› ä¸º0ã€1ã€2æ˜¯å†…ç½®çš„ï¼‰ï¼Œæ¯”å¦‚ExtraFiles[0]çš„fdæ˜¯3ï¼ŒExtraFiles[1]çš„ç¼–å·æ˜¯4</p>
<p>å¾ˆæ˜¾ç„¶ï¼Œæˆ‘ä»¬æ¯”è¾ƒéš¾çŸ¥é“ExtraFiles[0]åˆ°åº•æ˜¯ä¸ªå•¥ï¼Œæ‰€ä»¥runcä¸­ä¼šé€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’ï¼š</p>
<pre><code>fifoName := filepath.Join(c.stateDir, execFifoFilename)
fifo, err := os.OpenFile(fifoName, unix.O_PATH|unix.O_CLOEXEC, 0)
cmd.ExtraFiles = append(cmd.ExtraFiles, fifo)
stdioFdCount := 3
cmd.Env = append(cmd.Env,
		&quot;_LIBCONTAINER_FIFOFD=&quot;+strconv.Itoa(stdioFdCount+len(cmd.ExtraFiles)-1))
</code></pre>
<p>å­è¿›ç¨‹é€šè¿‡<code>os.NewFile(fd, $name)</code>å¾—åˆ°<code>*os.File</code>, name éšä¾¿å–ã€‚</p>
<pre><code>fifoFd, err := strconv.Atoi(os.Getenv(&quot;_LIBCONTAINER_FIFOFD&quot;))
if err != nil {
	return fmt.Errorf(&quot;unable to convert _LIBCONTAINER_FIFOFD: %w&quot;, err)
}
fifoFile = os.NewFile(uintptr(fifoFd), &quot;initfifo&quot;)
</code></pre>
<h1 id="start">start</h1>
<p>å½“æ‰§è¡Œcreateå‘½ä»¤å, initProcess ä¼šé˜»å¡åœ¨ fifo ç®¡é“ä¸Šï¼Œç›´åˆ°æœ‰å¦ä¸€ä¸ªè¿›ç¨‹æ‰“å¼€ç®¡é“</p>
<pre><code>fd, err := unix.Open(fifoPath, unix.O_WRONLY|unix.O_CLOEXEC, 0)
if err != nil {
	return &amp;os.PathError{Op: &quot;open exec fifo&quot;, Path: fifoPath, Err: err}
}
if _, err := unix.Write(fd, []byte(&quot;0&quot;)); err != nil {
	return &amp;os.PathError{Op: &quot;write exec fifo&quot;, Path: fifoPath, Err: err}
}

// ...

// æ‰§è¡Œç”¨æˆ·ä¸»è¿›ç¨‹
return system.Exec(name, l.config.Args, l.config.Env)
</code></pre>
<p>å½“æ‰§è¡Œstartå‘½ä»¤æ—¶ï¼Œä½œç”¨åªæ˜¯æ‰“å¼€å¹¶è¯»å–ä¸€ä¸‹ fifo ç®¡é“ï¼ˆè¿™é‡Œçš„è¯»å–å†…å®¹æ²¡å•¥å®é™…ä¿¡æ¯ï¼Œå¯èƒ½æ˜¯ä¸ºäº†å¹¶å‘è€ƒè™‘ï¼Œå¦‚æœå¹¶å‘è°ƒç”¨startï¼Œå‰ä¸€ä¸ªä¼šæˆåŠŸï¼Œåä¸€ä¸ªä¼šå¤±è´¥ï¼‰</p>
<pre><code>func (c *Container) exec() error {
// ...
	blockingFifoOpenCh := awaitFifoOpen(path)
// ...
}
</code></pre>
<h1 id="exec">exec</h1>
<p>åœ¨runcçš„è®¾è®¡ä¸­ï¼Œexecå’Œcreateçš„å·®åˆ«ä¸å¤§ï¼Œéƒ½æœ‰parentProcesså’ŒchildProcessçš„æ¦‚å¿µï¼Œåªä¸è¿‡ä»parent/childProcessçš„æ„ä¹‰ä¸Šå°†ï¼Œä¸€ä¸ªæ˜¯initProcessï¼Œä¸€ä¸ªæ˜¯setnsProcess, ä½†æ¯«æ— ç–‘é—®ï¼Œæµç¨‹éƒ½æ˜¯å·®ä¸å¤šçš„ï¼Œå› ä¸ºinitProcesså°±æ˜¯æ‰§è¡Œç”¨æˆ·ä¸»è¿›ç¨‹ï¼ŒsetnsProcesså°±æ˜¯æ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰å‘½ä»¤ã€‚<br>
initProcesséœ€è¦æ‰§è¡Œæ‰€æœ‰çš„åˆå§‹åŒ–æ“ä½œï¼Œæ¯”å¦‚rootfsï¼Œå„ç§nsï¼Œç½‘ç»œè·¯ç”±ç­‰ï¼Œsetnsåªéœ€è¦è¿›å…¥å¯¹åº”çš„nså³å¯ã€‚</p>
<h1 id="nsexec">nsexec</h1>
<p>åœ¨æ‹‰èµ·childProcessçš„è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€ä¸ªå¾ˆå…³é”®çš„æŠ€æœ¯ï¼Œ<code>nsexec()</code>, è¿™æ˜¯ä¸€ä¸ªcå†™çš„ä»£ç , ç”¨äºåœ¨ç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨è¿›å…¥ç‰¹å®šLinuxå‘½åç©ºé—´ã€‚
å¯ä»¥çœ‹åˆ°ï¼Œcgoçš„initå‡½æ•°é‡Œæ‰§è¡Œäº† <code>nsexec()</code>, è¿™ä¸ª <code>nsexec()</code> å°†ä¼šåœ¨ go çš„æ‰€æœ‰ä»£ç ï¼ˆå…¨å±€å˜é‡ã€initå‡½æ•°ã€mainå‡½æ•°ï¼‰ä¹‹å‰æ‰§è¡Œï¼Œ</p>
<blockquote>
<p><strong>attribute</strong>((constructor)) æ˜¯GCCç‰¹æ€§ï¼Œæ ‡è®° init() å‡½æ•°åœ¨ â€‹å…±äº«åº“åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œã€‚
å½“Goç¨‹åºå¯åŠ¨æ—¶ï¼ŒCä»£ç ä½œä¸ºå…±äº«åº“åŠ è½½ï¼Œinit() ä¼šç«‹å³è°ƒç”¨ nsexec()</p></blockquote>
<pre><code>//go:build linux &amp;&amp; !gccgo

package nsenter

/*
#cgo CFLAGS: -Wall
extern void nsexec();
void __attribute__((constructor)) init(void) {
	nsexec();
}
*/
import &quot;C&quot;

</code></pre>
<p>å½“æ­£å¸¸ä½¿ç”¨ runc æ—¶ï¼Œnsexecä¼šç›´æ¥é€€å‡ºï¼š</p>
<pre><code>pipenum = getenv_int(&quot;_LIBCONTAINER_INITPIPE&quot;);
if (pipenum &lt; 0) {
	/* We are not a runc init. Just return to go runtime. */
	return;
}
</code></pre>
<p>å½“æ‰§è¡Œ<code>runc init</code>æ—¶ï¼Œä¹Ÿå°±æ˜¯childProcessæ—¶ï¼Œnsexecæ­£å¸¸æ‰§è¡Œï¼Œ å®Œæˆäº† childProcess çš„nsè®¾ç½®(<code>err = setns(ns-&gt;fd, type);</code>)ï¼Œå¹¶è¿›è¡Œäº†å¤šæ¬¡cloneï¼š</p>
<pre><code>// å½“å‰åœ¨stage-0 è¿›ç¨‹

// åˆå§‹åŒ–å‡ ä¸ªpipe
int sync_child_pipe[2], sync_grandchild_pipe[2];
socketpair(AF_LOCAL, SOCK_STREAM, 0, sync_child_pipe)
socketpair(AF_LOCAL, SOCK_STREAM, 0, sync_grandchild_pipe)

switch (setjmp(env)) {
case STAGE_PARENT:{
	// å­è¿›ç¨‹ç›´æ¥è·³åˆ° STAGE_CHILD æ‰§è¡Œ
	// CLONE_PARENT å‚æ•°è¡¨ç¤ºcloneå‡ºå…„å¼Ÿè¿›ç¨‹ï¼Œè€Œéå­è¿›ç¨‹
	stage1_pid = clone(()=&gt;{longjmp(env, STAGE_CHILD)}, ca.stack_ptr, CLONE_PARENT | SIGCHLD, &amp;ca); 
	
	syncfd = sync_child_pipe[1];
	close(sync_child_pipe[0])

	stage1_complete = false;
	while (!stage1_complete) {
		// å¤„ç† syncfd ä¼ é€’è¿‡æ¥çš„ stage-1 çš„:
		// 1. SYNC_USERMAP_PLS(æ›´æ–°è¿›ç¨‹çš„uid/gid map: e.g. write_file(map, map_len, &quot;/proc/%d/gid_map&quot;, pid)) 
		// 2. SYNC_RECVPID_PLS(æ”¶åˆ°stage-1è¿›ç¨‹å‘é€æ¥çš„stage2_pid) , å¹¶å°†stage1_pid, stage2_pid å‘é€ç»™initPipe, åœ¨parentProcessä¸­ä¼šwait stage0_pid/stage1_pid, å¹¶å°†çœŸå®çš„pidè®¾ç½®ä¸ºstage2_pid
		// 3. SYNC_TIMEOFFSETS_PLS è®¾ç½®å®¹å™¨æ—¶é—´ç›¸å¯¹ç‰©ç†æœºçš„åç§»é‡ï¼Œè¿™æ˜¯ä¸€ç§time namepsace
		// 4. SYNC_CHILD_FINISHï¼šstage1_complete=true
	}

	syncfd = sync_grandchild_pipe[1];
	close(sync_grandchild_pipe[0])
	stage2_complete = false;
	while (!stage2_complete) {
		// å‘ stage-2 å‘é€ä¿¡æ¯

		s = SYNC_GRANDCHILD;
		write(syncfd, &amp;s, sizeof(s))
		read(syncfd, &amp;s, sizeof(s))
		if (s != SYNC_CHILD_FINISH){failed}
	}

	// stage-0 è¿›ç¨‹é€€å‡º
	exit(0);
}
case STAGE_CHILD:{
	// å½“å‰åœ¨stage-1è¿›ç¨‹

	syncfd = sync_child_pipe[0];
	close(sync_child_pipe[1])

	join_namespaces(config.namespaces)

	if (config.cloneflags &amp; CLONE_NEWUSER) {
		try_unshare(CLONE_NEWUSER, &quot;user namespace&quot;); // å¦‚æœæ˜¯rootlessæ¨¡å¼ï¼Œç”¨unshareå°†å½“å‰è¿›ç¨‹ç§»å…¥ user namespace ï¼ˆå¦‚æœæ˜¯è®©å­è¿›ç¨‹è¿›å…¥user namespaceï¼ŒæŠŠCLONE_NEWUSERä¼ ç»™cloneå°±è¡Œï¼‰
		
		// ...
		
		// è¯·æ±‚stage-0 è¿›è¡Œ user mappingï¼Œ å› ä¸ºstage-1 è¿›ç¨‹æ²¡æƒé™ï¼ˆå…·ä½“ä¸ºå•¥æ²¡æƒé™ä¸æ¸…æ¥šï¼Œçœ‹æºç æ³¨é‡Šæ˜¯å’ŒCLONE_PARENTæœ‰å…³ï¼‰
		s = SYNC_USERMAP_PLS;
		write(syncfd, &amp;s, sizeof(s))
		read(syncfd, &amp;s, sizeof(s))
		if (s != SYNC_USERMAP_ACK){failed}

		// ...

		setresuid(0, 0, 0) // å°†å½“å‰è¿›ç¨‹ä½œä¸ºnsé‡Œçš„rootï¼Œä¹Ÿå°±æ˜¯uid=0
	}

	try_unshare(config.cloneflags, &quot;remaining namespaces&quot;); // æ³¨é‡Šé‡Œæœ‰æåˆ°ï¼ŒæŸäº›å†…æ ¸çš„cloneå¯¹ä¸€äº›å‚æ•°çš„è”åˆä½¿ç”¨æœ‰ç‚¹é—®é¢˜ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œunshareã€‚
	// å½“unshare CLONE_PID æ—¶ï¼Œå½“å‰è¿›ç¨‹çš„pidä»åœ¨åŸpid nsï¼Œå…¶å­è¿›ç¨‹åœ¨æ–°çš„pid namespace, pid = 1

	
	// ...

	// å­è¿›ç¨‹ç›´æ¥è·³åˆ° STAGE_INIT æ‰§è¡Œ
	stage2_pid = clone(()=&gt;{longjmp(env, STAGE_INIT)}, ca.stack_ptr, CLONE_PARENT | SIGCHLD, &amp;ca);

	s = SYNC_RECVPID_PLS
	write(syncfd, &amp;s, sizeof(s))
	write(syncfd, &amp;stage2_pid, sizeof(stage2_pid))
	read(syncfd, &amp;s, sizeof(s))
	if (s != SYNC_RECVPID_ACK){failed}

	s = SYNC_CHILD_FINISH;
	write(syncfd, &amp;s, sizeof(s))

	// stage-1 è¿›ç¨‹é€€å‡º
	exit(0);
}
case STAGE_INIT:{
	syncfd = sync_grandchild_pipe[0];
	close(sync_grandchild_pipe[1]) 
	close(sync_child_pipe[0])

	read(syncfd, &amp;s, sizeof(s))
	if (s != SYNC_GRANDCHILD){failed}

	setsid()
	setuid(0)
	setgid(0)

	s = SYNC_CHILD_FINISH;
	write(syncfd, &amp;s, sizeof(s))
	close(sync_grandchild_pipe[0])
	return;
}
}
</code></pre>
<h1 id="fs-mount">FS mount</h1>
<p>è¿™é‡Œè®²ä¸€ä¸‹æ–‡ä»¶æˆ–è€…rootfsæ˜¯æ€ä¹ˆæŒ‚è½½çš„</p>
<p>é¦–å…ˆï¼Œrunc bundleè¦æ±‚æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº†ä¸€ä¸ªrootfsï¼Œå…¶æ¬¡ï¼Œæˆ‘ä»¬è¿›å…¥ä¸€ä¸ªå…¨æ–°çš„mount namespaceã€‚</p>
<h2 id="rootfs">rootfs</h2>
<ol>
<li>å¯¹rootfsçš„mountå¯ä»¥é€šè¿‡chrootæˆ–è€…pivotroot
<ol>
<li>å¦‚æœæ²¡æœ‰æŒ‡å®š new mount namespace, é‚£å°±ç›´æ¥chroot: unix.Chroot(&quot;.&quot;); unix.Chdir(&quot;/&quot;); (è¿™é‡Œåé¢å†è°ƒç”¨ä¸€æ¬¡chdirï¼Œé¿å…rootfsåˆ‡æ¢åè·¯å¾„æ²¡å¯¹é½)</li>
<li>ä¸€èˆ¬æ¥è¯´ï¼Œéƒ½æŒ‡å®šäº†new mount namespaceï¼Œè¿™æ—¶ä½¿ç”¨ unix.PivotRoot(&quot;.&quot;, &ldquo;.&quot;)ï¼Œä¸­é—´æœ‰ä¸€äº›å¤æ‚çš„å†…æ ¸å±‚é¢çš„trickï¼Œçœ‹äº†ä¸€äº›issueä¹Ÿæ²¡å¤ªçœ‹æ‡‚ï¼Œè¿™é‡Œä¸èµ˜è¿°äº†ã€‚</li>
</ol>
</li>
</ol>
<h2 id="bind-mount">bind mount</h2>
<p>å¯¹äºå¸¸è§çš„æ–‡ä»¶/ç›®å½•æŒ‚è½½ï¼Œéƒ½æ˜¯é€šè¿‡mount -o bind.<br>
é¦–å…ˆåœ¨ç›®æ ‡æŒ‚è½½ç›®å½•åˆ›å»ºä¸€ä¸ªæŒ‚è½½ç‚¹ï¼š</p>
<pre><code>destDir, destBase := filepath.Split(dest)
destDirFd, err := utils.MkdirAllInRootOpen(rootfs, destDir, 0o755)
unix.Mknodat(int(destDirFd.Fd()), destBase, unix.S_IFREG|0o644, 0)
</code></pre>
<p>éšåå°†å¯¹åº”æ–‡ä»¶æˆ–ç›®å½•çš„fdå¯¹åº”çš„æ–‡ä»¶ï¼ˆå½¢å¦‚ /proc/self/fd/111ï¼‰ æŒ‚åœ¨ç›®æ ‡çš„fdï¼ˆå½¢å¦‚ /proc/self/fd/112ï¼‰ä¸Šï¼š
unix.Mount(src, dst, fstype, flags, data)</p>
<h1 id="console-io">Console IO</h1>
<p>ttyæ˜¯æ€ä¹ˆåˆ›å»ºçš„ï¼Œä»¥åŠæ€ä¹ˆç”Ÿæ•ˆçš„ï¼Œå³æ€ä¹ˆæŠŠæŸä¸ªè¿›ç¨‹çš„stdioå…³è”åˆ°ç»ˆç«¯çš„stdioï¼Ÿ</p>
<blockquote>
<p>å¦‚æœæˆ‘ä»¬ç›´æ¥åœ¨å‰å°è°ƒç”¨æŸä¸ªè¿›ç¨‹ï¼Œå€’æ˜¯ä¸ç”¨æ‹…å¿ƒttyçš„é—®é¢˜ï¼Œéƒ½ä¼šè‡ªåŠ¨ç»§æ‰¿ttyçš„ioï¼Œä½†å¦‚æœæ˜¯dockerd/containerd è¿™ç§daemonåœºæ™¯å‘¢ï¼Ÿ</p></blockquote>
<h2 id="mount">mount</h2>
<p>é€šè¿‡æ‰“å¼€ <code>f = os.OpenFile(&quot;/dev/ptmx&quot;, unix.O_RDWR|unix.O_NOCTTY|unix.O_CLOEXEC, 0)</code> æ–‡ä»¶ï¼Œå°±ä¼šæ‹¿åˆ°ä¸€ä¸ªttyçš„fdï¼Œé€šè¿‡ <code>unix.Syscall(unix.SYS_IOCTL, f.Fd(), &amp;u, ...)</code> ç³»ç»Ÿè°ƒç”¨ï¼Œæ‹¿åˆ°å¯¹åº”çš„åˆ›å»ºå‡ºæ¥çš„ttyçš„æ–‡ä»¶åœ°å€<code>fmt.Sprintf(&quot;/dev/pts/%d&quot;, u)</code>ï¼Œ éšåï¼Œå°†ttyçš„æ–‡ä»¶åœ°å€mountåˆ° <code>/dev/console</code>, éšåæ‰“å¼€slavepathï¼Œå°†å¯¹åº”çš„fd dupåˆ° 0ã€1ã€2 ä¸Šï¼Œè¿™æ„å‘³ç€å¯¹0/1/2çš„é‡å®šå‘</p>
<p>åœ¨è¿™é‡Œï¼Œå­˜åœ¨consoleçš„masterå’Œslaveï¼Œmasterå°±æ˜¯æ‰“å¼€ <code>/dev/ptmx</code> å¾—åˆ°çš„fdï¼Œ slaveå°±æ˜¯ <code>unix.Syscall(unix.SYS_IOCTL</code> å¾—åˆ°çš„ fd</p>
<blockquote>
<p>â€‹Master â†’ Slaveï¼šæ§åˆ¶ç«¯ï¼ˆå¦‚ç”¨æˆ·é”®ç›˜è¾“å…¥ï¼‰å‘é€æ•°æ®åˆ°è¢«æ§è¿›ç¨‹ã€‚
â€‹Slave â†’ Masterï¼šè¢«æ§è¿›ç¨‹çš„è¾“å‡ºï¼ˆå¦‚å‘½ä»¤ç»“æœï¼‰è¿”å›ç»™æ§åˆ¶ç«¯ã€‚
Master/Slave ä¹‹é—´çš„æ•°æ®æ‹·è´æ˜¯å†…æ ¸è‡ªåŠ¨å®Œæˆçš„ï¼ŒåŸºæœ¬ä¸Šæ¥è¯´ï¼Œåªè¦æŸä¸ªè¢«æ§è¿›ç¨‹çš„stdioè¢«é‡å®šå‘åˆ°slaveï¼Œå°±æ­£å¸¸å…³è”åˆ°consoleçš„stdioäº†ã€‚æˆ‘ä»¬æ“ä½œçš„ç›®çš„çš„æœ¬è´¨å°±æ˜¯æ€ä¹ˆæŠŠæŸä¸ªè¿›ç¨‹çš„stdioå…³è”åˆ°ç»ˆç«¯çš„stdioã€‚</p></blockquote>
<pre><code>åœ¨ new mount namespace é‡Œé¢æ‰§è¡Œ


// setupConsole sets up the console from inside the container, and sends the
// master pty fd to the config.Pipe (using cmsg). This is done to ensure that
// consoles are scoped to a container properly (see runc#814 and the many
// issues related to that). This has to be run *after* we've pivoted to the new
// rootfs (and the users' configuration is entirely set up).
func setupConsole(socket *os.File, config *initConfig, mount bool) error {
	defer socket.Close()
	// At this point, /dev/ptmx points to something that we would expect. We
	// used to change the owner of the slave path, but since the /dev/pts mount
	// can have gid=X set (at the users' option). So touching the owner of the
	// slave PTY is not necessary, as the kernel will handle that for us. Note
	// however, that setupUser (specifically fixStdioPermissions) *will* change
	// the UID owner of the console to be the user the process will run as (so
	// they can actually control their console).

	pty, slavePath, err := console.NewPty()
	if err != nil {
		return err
	}
	// After we return from here, we don't need the console anymore.
	defer pty.Close()

	if config.ConsoleHeight != 0 &amp;&amp; config.ConsoleWidth != 0 {
		err = pty.Resize(console.WinSize{
			Height: config.ConsoleHeight,
			Width:  config.ConsoleWidth,
		})
		if err != nil {
			return err
		}
	}

	// Mount the console inside our rootfs.
	if mount {
		if err := mountConsole(slavePath); err != nil {
			return err
		}
	}
	// While we can access console.master, using the API is a good idea.
	if err := utils.SendRawFd(socket, pty.Name(), pty.Fd()); err != nil {
		return err
	}
	runtime.KeepAlive(pty)

	// Now, dup over all the things.
	return dupStdio(slavePath)
}

// NewPty creates a new pty pair
// The master is returned as the first console and a string
// with the path to the pty slave is returned as the second
func NewPty() (Console, string, error) {
	f, err := openpt()
	if err != nil {
		return nil, &quot;&quot;, err
	}
	slave, err := ptsname(f)
	if err != nil {
		return nil, &quot;&quot;, err
	}
	if err := unlockpt(f); err != nil {
		return nil, &quot;&quot;, err
	}
	m, err := newMaster(f)
	if err != nil {
		return nil, &quot;&quot;, err
	}
	return m, slave, nil
}

// openpt allocates a new pseudo-terminal by opening the /dev/ptmx device
func openpt() (*os.File, error) {
	return os.OpenFile(&quot;/dev/ptmx&quot;, unix.O_RDWR|unix.O_NOCTTY|unix.O_CLOEXEC, 0)
}

// dupStdio opens the slavePath for the console and dups the fds to the current
// processes stdio, fd 0,1,2.
func dupStdio(slavePath string) error {
	fd, err := unix.Open(slavePath, unix.O_RDWR, 0)
	if err != nil {
		return &amp;os.PathError{
			Op:   &quot;open&quot;,
			Path: slavePath,
			Err:  err,
		}
	}
	for _, i := range []int{0, 1, 2} {
		if err := unix.Dup3(fd, i, 0); err != nil {
			return err
		}
	}
	return nil
}


// mount initializes the console inside the rootfs mounting with the specified mount label
// and applying the correct ownership of the console.
func mountConsole(slavePath string) error {
	f, err := os.Create(&quot;/dev/console&quot;)
	if err != nil &amp;&amp; !os.IsExist(err) {
		return err
	}
	if f != nil {
		// Ensure permission bits (can be different because of umask).
		if err := f.Chmod(0o666); err != nil {
			return err
		}
		f.Close()
	}
	return mount(slavePath, &quot;/dev/console&quot;, &quot;bind&quot;, unix.MS_BIND, &quot;&quot;)
}
</code></pre>

    </div>
    <div class="article-footer">
<blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    <li class="post-copyright-link hidden-xs">
      <strong>Permalink: </strong>
      <a href="https://wymli.github.io/2025/03/container-6.%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80%E4%B9%8Brunc%E6%BA%90%E7%A0%81/" title="[container] 6.å®¹å™¨åŸºç¡€ä¹‹runcæºç " target="_blank" rel="external">https://wymli.github.io/2025/03/container-6.%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80%E4%B9%8Brunc%E6%BA%90%E7%A0%81/</a>
    </li>
    <li class="post-copyright-license">
      <strong>License: </strong>
        <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN</a>
    </li>
  </ul>
</blockquote>

<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/wymli" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="https://wymli.github.io/me.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/wymli" target="_blank"><span class="text-dark">Li Weiming</span><small class="ml-1x">wymli@sysu.cse</small></a></h3>
        <div>ONE CAN GO FAST</div>
      </div>
    </figure>
  </div>
</div>

    </div>
  </article>
</div><nav class="bar bar-footer clearfix" data-stick-bottom>
    <div class="bar-inner">
        <ul class="pager pull-left">
            <li class="prev">
                <a href="https://wymli.github.io/2025/03/container-5.%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80%E4%B9%8Boci-dist/" title="[container] 5.å®¹å™¨åŸºç¡€ä¹‹oci dist"><i
                        class="icon icon-angle-left"
                        aria-hidden="true"></i><span>&nbsp;&nbsp;Older</span></a>
            </li>
            <li class="next">
                <a href="https://wymli.github.io/2025/03/worklfow-1.-airflow/"
                    title="[airflow] airflow"><span>Newer&nbsp;&nbsp;</span><i
                        class="icon icon-angle-right" aria-hidden="true"></i></a>
            </li>
            
            <li class="toggle-toc">
                <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false"
                    title="Catalogue" role="button">
                    <span>[&nbsp;</span><span>Catalogue</span>
                    <i class="text-collapsed icon icon-anchor"></i>
                    <i class="text-in icon icon-close"></i>
                    <span>]</span>
                </a>
            </li>
        </ul>
        <div class="bar-right">
            <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter"
                data-mobile-sites="weibo,qq,qzone"></div>
        </div>
    </div>
</nav>


</main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
<ul class="social-links">
    <li><a href="https://github.com/wymli" target="_blank" title="github" data-toggle=tooltip data-placement=top >
            <i class="icon icon-github"></i></a></li>
    <li><a href="https://wymli.github.io/index.xml" target="_blank" title="rss" data-toggle=tooltip data-placement=top >
            <i class="icon icon-rss"></i></a></li>
</ul>
  <div class="copyright">
    &copy;2021  -
    2025
    <div class="publishby">
        Theme by <a href="https://github.com/xiaoheiAh" target="_blank"> xiaoheiAh </a>base on<a href="https://github.com/xiaoheiAh/hugo-theme-pure" target="_blank"> pure</a>.
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
            showMathMenu: false, //disables context menu
            tex2jax: {
            inlineMath: [ ['$','$'], ['\\(','\\)'] ]
           }
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    window.jQuery || document.write('\x3Cscript src="js/jquery.min.js"><\/script>')
</script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/python.min.js" defer></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/javascript.min.js" defer></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/go.min.js" defer></script><script>
    hljs.configure({
        tabReplace: '    ', 
        classPrefix: ''     
        
    })
    hljs.initHighlightingOnLoad();
</script>
<script src="https://wymli.github.io/js/application.min.e4989ab4dc212027af8773861b05b6bc333a1217f6b0a1b3377a3a3dbd454483.js"></script>
<script src="https://wymli.github.io/js/plugin.min.353ef3573cf0beb9b69d43450140ff59f497f732396f539052fc4973c6330fdb.js"></script>

<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            ROOT_URL: 'https:\/\/wymli.github.io\/',
            CONTENT_URL: 'https:\/\/wymli.github.io\/\/searchindex.json ',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script type="text/javascript" src="https://wymli.github.io/js/insight.min.716b0c6a00b68ccc31a2b65345f3412f4246ffa94a90f8e25d525528b4504f9937880692bbe619023233caba5d0a17ebe23d7cfb57cd3a88f23ea337ad5e4d00.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3',
        
        hasInnerContainers: true,
    });
</script>



  </body>
</html>
